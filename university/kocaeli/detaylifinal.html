<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KOÜ | Hedef Final (BDS/MDS)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Manrope:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b132b;
  --bg2:#111b33;
  --card:#0f172a;
  --glass:rgba(255,255,255,0.04);
  --accent:#f7b733;
  --accent2:#21e6c1;
  --border:#1f2a44;
  --text:#e8eefb;
  --muted:#9fb1d1;
}
.shell{max-width:900px;margin:auto;padding:24px 18px 30px;}
nav.nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
nav.nav a{
  color:var(--text);text-decoration:none;padding:10px 14px;
  border:1px solid var(--border);border-radius:12px;
  background:rgba(255,255,255,0.05);font-weight:800;
  transition:background .15s ease,border-color .15s ease,color .15s ease;
}
nav.nav a.active{border-color:var(--accent);color:var(--accent);background:rgba(247,183,51,0.12);}
*{box-sizing:border-box;}
body{
  margin:0;
  padding:28px 18px 34px;
  font-family:"Space Grotesk","Manrope",system-ui,-apple-system,sans-serif;
  background:radial-gradient(circle at 18% 20%, rgba(33,230,193,0.16), transparent 32%),
             radial-gradient(circle at 84% 12%, rgba(247,183,51,0.16), transparent 32%),
             linear-gradient(145deg, var(--bg), var(--bg2));
  color:var(--text);
  line-height:1.6;
}
.container{
  max-width:900px;
  margin:auto;
  background:var(--glass);
  border:1px solid var(--border);
  border-radius:18px;
  padding:22px;
  box-shadow:0 18px 50px rgba(0,0,0,0.28);
}
h2{text-align:center;color:var(--accent);margin:0 0 14px;letter-spacing:-0.3px}
.bar{display:flex;flex-wrap:wrap;align-items:center;gap:10px;justify-content:space-between;margin-bottom:10px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.full{grid-column:1/-1}
label{font-weight:700;margin-top:6px;display:block;color:var(--text);font-size:14px}
input,select,button{
  width:100%;
  padding:11px 12px;
  margin-top:6px;
  box-sizing:border-box;
  font-size:15px;
  border-radius:12px;
  border:1px solid var(--border);
  background:rgba(255,255,255,0.04);
  color:var(--text);
}
input:focus,select:focus{
  outline:none;
  border-color:var(--accent2);
  box-shadow:0 0 0 3px rgba(33,230,193,0.2);
}
button{
  background:linear-gradient(120deg,var(--accent),#f37335);
  color:#0b0c10;
  border:none;
  border-radius:12px;
  font-weight:800;
  cursor:pointer;
  box-shadow:0 12px 30px rgba(243,115,53,0.25);
  transition:transform .18s ease, box-shadow .18s ease;
}
button:hover{transform:translateY(-2px);box-shadow:0 16px 36px rgba(243,115,53,0.32);}
.muted{font-size:12px;color:var(--muted);margin-top:4px}
.card{
  background:rgba(255,255,255,0.03);
  border:1px solid var(--border);
  border-left:6px solid var(--accent2);
  border-radius:12px;
  padding:12px;
  margin-top:12px;
}
.warn{background:rgba(247,183,51,0.08);border-left-color:#f59e0b}
.bad{background:rgba(255,0,0,0.07);border-left-color:#ef4444}
.ok{background:rgba(33,230,193,0.08);border-left-color:#21e6c1}
.extraGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
.extraTitle{font-weight:800;margin-bottom:6px}
.checkRow{display:flex;align-items:center;gap:10px;margin-top:8px}
.pill{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,0.04);font-size:12px;color:var(--text);margin-right:6px;margin-top:6px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border-bottom:1px solid rgba(255,255,255,0.08);padding:8px 6px;text-align:left;font-size:13px}
th{color:#cfe0ff;font-weight:900}
@media(max-width:700px){.row{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div class="shell">
  <nav class="nav">
    <a href="index.html">Ana Sayfa</a>
    <a href="harf_notu_otomatik_grafikli.html">Harf Notu + Grafik</a>
    <a href="heatmap.html">Heatmap</a>
    <a class="active" href="detaylifinal.html">Hedef Final</a>
    <a href="anogano.html">AGNO / GANO</a>
    <a href="hakkinda.html">Hakkında</a>
  </nav>

  <div class="container">
    <div class="bar">
      <div>
        <h2>KOÜ | Hedef Final Hesaplayıcı (BDS/MDS)</h2>
        <div class="muted" id="uniNote">
          Bu sayfa <b>unofficial</b> bir simülasyondur. KOÜ özeti: <b>Final/Büt &lt; 40 ⇒ FF</b>, <b>N &lt; 25 veya X̄ ≥ 80 ⇒ MDS (Tablo-1)</b>,
          <b>Bütünleme ⇒ MDS</b>, <b>DSN &lt; 15 ⇒ BDS dışı (büt gerekir)</b>, <b>Devamsız ⇒ D</b>.
        </div>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Vize Notun</label>
        <input id="inpMyMid" type="number" min="0" max="100" placeholder="0-100">
      </div>
      <div>
        <label>Sınıf Vize Ortalaması</label>
        <input id="inpClsMid" type="number" min="0" max="100" placeholder="0-100">
      </div>

      <div>
        <label>Vize Ağırlığı (%)</label>
        <input id="inpWMid" type="number" min="0" max="100" value="40">
      </div>
      <div>
        <label>Final Ağırlığı (%)</label>
        <input id="inpWFinal" type="number" min="0" max="100" value="60">
        <div class="muted">Ek kalemlerle toplam %100 olmalı.</div>
      </div>

      <div>
        <label>Sınıf Final Ortalaması</label>
        <input id="inpClsFinal" type="number" min="0" max="100" placeholder="örn: 50">
        <div class="muted">X̄ (sınıf DSN ort.) hesaplanırken kullanılır.</div>
      </div>

      <div>
        <label>Bağıl değerlendirmeye katılan öğrenci sayısı (N)</label>
        <input id="inpN" type="number" min="1" step="1" value="30">
        <div class="muted">KOÜ: N &lt; 25 ise MDS uygulanır.</div>
      </div>

      <div>
        <label>Sınav türü</label>
        <select id="inpIsMakeup">
          <option value="0" selected>Final</option>
          <option value="1">Bütünleme</option>
        </select>
        <div class="muted">KOÜ: Bütünleme sonrası harf notu Tablo-1 (MDS).</div>
      </div>

      <div class="checkRow">
        <input id="chkAbs" type="checkbox" style="width:auto;transform:scale(1.1)">
        <label for="chkAbs" style="margin:0;font-weight:800">Devamsızım (D)</label>
      </div>

      <div class="full">
        <label>Hedef Harf Notu</label>
        <select id="inpTarget">
          <option value="AA">AA</option>
          <option value="BA">BA</option>
          <option value="BB">BB</option>
          <option value="CB">CB</option>
          <option value="CC" selected>CC</option>
          <option value="DC">DC</option>
          <option value="DD">DD</option>
          <option value="FD">FD</option>
          <option value="FF">FF</option>
        </select>
        <div class="muted">Not: KOÜ’de <b>Final/Büt &lt; 40</b> ise hedef ne olursa olsun sonuç <b>FF</b>.</div>
      </div>

      <div class="full">
        <label>Tahmini Standart Sapma (σ) <span class="muted">(opsiyonel)</span></label>
        <input id="inpSigma" type="number" min="1" max="50" placeholder="boş bırakırsan 10 / 15 / 20 senaryosu">
        <div class="muted">σ sadece <b>BDS</b> modunda kullanılır. MDS’de etkisizdir.</div>
      </div>

      <div class="full checkRow">
        <input id="chkExtra" type="checkbox" style="width:auto;transform:scale(1.1)">
        <label for="chkExtra" style="margin:0;font-weight:800">Ek değerlendirme var (ödev/quiz/proje/lab...)</label>
      </div>

      <div id="extraArea" class="full" style="display:none">
        <label>Kaç adet ek kalem?</label>
        <select id="inpExtraCount">
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
        </select>
        <div class="muted">Her ek kalem için: ad, ağırlık %, senin notun, sınıf ortalaman</div>
        <div id="extraList"></div>
      </div>

      <div class="full">
        <button id="btnCalc" type="button" onclick="calculate()">Hesapla</button>
      </div>
    </div>

    <div id="out"></div>
  </div>
</div>

<script>
/* =========================
   KOÜ — Hedef Final (BDS/MDS)
   Kurallar (özet):
   - Devamsız -> D (DSN hesaplanmaz)
   - Final/Büt < 40 -> FF
   - N < 25 -> MDS (Tablo-1)
   - X̄ >= 80 -> MDS (Tablo-1)
   - Bütünleme -> MDS (Tablo-1)
   - BDS: DSN<15 -> bağıl dışı (büt gerekir)
   - T = 50 + 10*((DSN - X̄)/σ)
   - Tablo-2 harfi, DSN'in Tablo-1 karşılığından düşük olamaz (koruma)
   ========================= */

const EXAM_MIN = 40;      // KOÜ final/büt alt sınırı
const MDS_N_LIMIT = 25;   // KOÜ: N<25 -> MDS
const MDS_MEAN_LIMIT = 80;// KOÜ: X̄>=80 -> MDS (Üstün başarı)
const BDS_DSN_MIN = 15;   // KOÜ: DSN<15 -> BDS dışı
const SIGMA_DEFAULTS = [10,15,20]; // σ bilinmiyorsa senaryo (unofficial)

const LETTER_ORDER = ["FF","FD","DD","DC","CC","CB","BB","BA","AA"];
const idx = (L)=> LETTER_ORDER.indexOf(L);
const geq = (a,b)=> idx(a) >= idx(b); // a >= b?

function round2(x){ return Math.round(x*100)/100; }
function fmt(x){ return Number.isFinite(x) ? round2(x).toFixed(2) : "—"; }

function table1Letter(dsn){
  const x = Number(dsn);
  if(!Number.isFinite(x)) return "FF";
  if(x >= 90) return "AA";
  if(x >= 80) return "BA";
  if(x >= 75) return "BB";
  if(x >= 70) return "CB";
  if(x >= 60) return "CC";
  if(x >= 50) return "DC";
  if(x >= 40) return "DD";
  if(x >= 30) return "FD";
  return "FF";
}

function pickTable2Row(xbar){
  // Üstün başarı: 80<=X̄<=100 => Tablo-1 (MDS) (burada BDS'ye sokmuyoruz)
  const x = Number(xbar);
  if(x > 70 && x < 80) return "Mükemmel";
  if(x > 62.5 && x <= 70) return "Çok iyi";
  if(x > 57.5 && x <= 62.5) return "İyi";
  if(x > 52.5 && x <= 57.5) return "Ortanın üstü";
  if(x > 47.5 && x <= 52.5) return "Orta";
  if(x > 42.5 && x <= 47.5) return "Zayıf";
  return "Kötü";
}

function letterFromTable2(xbar, t){
  const lvl = pickTable2Row(xbar);
  const T = Number(t);

  const bands = {
    "Mükemmel": [
      ["FF",-Infinity,23.99],
      ["FD",24,28.99],
      ["DD",29,33.99],
      ["DC",34,38.99],
      ["CC",39,43.99],
      ["CB",44,48.99],
      ["BB",49,53.99],
      ["BA",54,58.99],
      ["AA",59,Infinity],
    ],
    "Çok iyi": [
      ["FF",-Infinity,25.99],
      ["FD",26,30.99],
      ["DD",31,35.99],
      ["DC",36,40.99],
      ["CC",41,45.99],
      ["CB",46,50.99],
      ["BB",51,55.99],
      ["BA",56,60.99],
      ["AA",61,Infinity],
    ],
    "İyi": [
      ["FF",-Infinity,27.99],
      ["FD",28,32.99],
      ["DD",33,37.99],
      ["DC",38,42.99],
      ["CC",43,47.99],
      ["CB",48,52.99],
      ["BB",53,57.99],
      ["BA",58,62.99],
      ["AA",63,Infinity],
    ],
    "Ortanın üstü": [
      ["FF",-Infinity,29.99],
      ["FD",30,34.99],
      ["DD",35,39.99],
      ["DC",40,44.99],
      ["CC",45,49.99],
      ["CB",50,54.99],
      ["BB",55,59.99],
      ["BA",60,64.99],
      ["AA",65,Infinity],
    ],
    "Orta": [
      ["FF",-Infinity,31.99],
      ["FD",32,36.99],
      ["DD",37,41.99],
      ["DC",42,46.99],
      ["CC",47,51.99],
      ["CB",52,56.99],
      ["BB",57,61.99],
      ["BA",62,66.99],
      ["AA",67,Infinity],
    ],
    "Zayıf": [
      ["FF",-Infinity,33.99],
      ["FD",34,38.99],
      ["DD",39,43.99],
      ["DC",44,48.99],
      ["CC",49,53.99],
      ["CB",54,58.99],
      ["BB",59,63.99],
      ["BA",64,68.99],
      ["AA",69,Infinity],
    ],
    "Kötü": [
      ["FF",-Infinity,35.99],
      ["FD",36,40.99],
      ["DD",41,45.99],
      ["DC",46,50.99],
      ["CC",51,55.99],
      ["CB",56,60.99],
      ["BB",61,65.99],
      ["BA",66,70.99],
      ["AA",71,Infinity],
    ]
  };

  for(const [L,lo,hi] of (bands[lvl] || bands["Kötü"])){
    if(T >= lo && T <= hi) return { letter:L, level:lvl };
  }
  return { letter:"FF", level:lvl };
}

function decideSystem({isMakeup, N, classAvg}){
  if(isMakeup) return "MDS";
  if(N < MDS_N_LIMIT) return "MDS";
  if(classAvg >= MDS_MEAN_LIMIT) return "MDS";
  return "BDS";
}

function computeLetterKO({absent, examScore, dsn, classAvg, sigma, system}){
  if(absent) return { letter:"D", sys:"—", note:"Devamsız (D) — DSN hesaplanmaz." };

  if(examScore < EXAM_MIN){
    return { letter:"FF", sys:system, note:`Final/Büt < ${EXAM_MIN} ⇒ FF` };
  }

  if(system === "MDS"){
    const L = table1Letter(dsn);
    return { letter:L, sys:"MDS", note:"MDS (Tablo-1)" };
  }

  // BDS
  if(dsn < BDS_DSN_MIN){
    return { letter:"FF", sys:"BDS", note:`DSN < ${BDS_DSN_MIN} ⇒ BDS dışı (bütünleme gerekir)` };
  }

  const z = (dsn - classAvg) / sigma;
  const t = 50 + 10*z;
  const t2 = letterFromTable2(classAvg, t);
  const base = table1Letter(dsn);

  const finalLetter = geq(t2.letter, base) ? t2.letter : base;
  const protectedFlag = finalLetter !== t2.letter;

  return {
    letter: finalLetter,
    sys: "BDS",
    note: protectedFlag ? "BDS (Tablo-2) + Koruma (Tablo-1 altına düşmez)" : "BDS (Tablo-2)",
    z, t, level: t2.level, raw: t2.letter, base
  };
}

/* ---------- extras UI ---------- */
const chkExtra=document.getElementById("chkExtra");
const extraArea=document.getElementById("extraArea");
const inpExtraCount=document.getElementById("inpExtraCount");
const extraList=document.getElementById("extraList");

chkExtra.addEventListener("change", ()=>{
  extraArea.style.display = chkExtra.checked ? "block" : "none";
  renderExtras();
});
inpExtraCount.addEventListener("change", renderExtras);

function renderExtras(){
  extraList.innerHTML="";
  if(!chkExtra.checked) return;
  const n=Number(inpExtraCount.value);
  for(let i=1;i<=n;i++){
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <div class="extraTitle">Ek Kalem ${i}</div>
      <div class="extraGrid">
        <div>
          <label>Ad (opsiyonel)</label>
          <input id="exName${i}" placeholder="örn: Ödev">
        </div>
        <div>
          <label>Ağırlık (%)</label>
          <input id="exW${i}" type="number" min="0" max="100" placeholder="örn: 10">
        </div>
        <div>
          <label>Senin Notun</label>
          <input id="exMy${i}" type="number" min="0" max="100" placeholder="0-100">
        </div>
        <div>
          <label>Sınıf Ortalaması</label>
          <input id="exCls${i}" type="number" min="0" max="100" placeholder="0-100">
        </div>
      </div>
    `;
    extraList.appendChild(div);
  }
}
renderExtras();

/* ---------- helpers ---------- */
function num(id){ return Number(document.getElementById(id).value); }
function txt(id){ return (document.getElementById(id).value || "").trim(); }

function validate01(v){ return Number.isFinite(v) && v>=0 && v<=100; }

function collectExtras(){
  let extras=[];
  if(!chkExtra.checked) return extras;
  const n=Number(inpExtraCount.value);
  for(let i=1;i<=n;i++){
    const name=(document.getElementById(`exName${i}`).value || `Ek ${i}`).trim();
    const wPct=Number(document.getElementById(`exW${i}`).value);
    const my=Number(document.getElementById(`exMy${i}`).value);
    const cls=Number(document.getElementById(`exCls${i}`).value);

    extras.push({name,wPct,my,cls});
  }
  return extras;
}

function weightCheck(wMidPct,wFinalPct,extras){
  const sum = wMidPct + wFinalPct + extras.reduce((a,x)=>a + (Number(x.wPct)||0), 0);
  return sum;
}

/* ---------- target search ---------- */
function minFinalForTarget({targetLetter, absent, classAvg, system, sigma, wFinal, userConst}){
  if(absent) return { ok:false, reason:"Devamsız (D) — hedef final hesaplanmaz." };

  // hedef FF seçilirse: teknik olarak final 0 ile de FF alınır ama KOÜ barajı 40 üstü “başarılı olabilme” şartıdır.
  // Bu sayfada “hedef final” mantığı gereği aramayı 40'tan başlatıyoruz.
  const start = EXAM_MIN;
  const end = 100;

  const meets = (fin)=>{
    const dsn = userConst + fin*wFinal;
    const res = computeLetterKO({absent:false, examScore:fin, dsn, classAvg, sigma, system});
    return { dsn, res };
  };

  let found = null;
  for(let f = start; f <= end + 1e-9; f += 0.1){
    const fin = Math.round(f*10)/10;
    const {dsn,res} = meets(fin);
    if(res.letter === "D") continue;
    if(geq(res.letter, targetLetter)){
      found = { fin, dsn, res };
      break;
    }
  }
  if(!found){
    return { ok:false, reason:"Bu hedef için 40–100 aralığında final bulunamadı (imkânsız olabilir)." };
  }

  // refine to 0.01 around found
  const lo = Math.max(start, found.fin - 0.2);
  const hi = Math.min(end, found.fin);
  let best = found;
  for(let f = lo; f <= hi + 1e-9; f += 0.01){
    const fin = Math.round(f*100)/100;
    const {dsn,res} = meets(fin);
    if(geq(res.letter, targetLetter)){
      best = { fin, dsn, res };
      break;
    }
  }
  return { ok:true, fin:best.fin, dsn:best.dsn, detail:best.res };
}

function buildContributionTable({wMidPct,wFinalPct,myMid,clsMid,clsFinal,extras, wMid,wFinal}){
  let rows = `
    <tr>
      <td><b>Vize</b></td><td>${wMidPct}%</td><td>${myMid}</td><td>${clsMid}</td>
      <td>${fmt(myMid*wMid)}</td><td>${fmt(clsMid*wMid)}</td>
    </tr>
    <tr>
      <td><b>Final (?)</b></td><td>${wFinalPct}%</td><td>?</td><td>${clsFinal}</td>
      <td>?</td><td>${fmt(clsFinal*wFinal)}</td>
    </tr>
  `;
  extras.forEach(x=>{
    const ww = (Number(x.wPct)||0)/100;
    rows += `
      <tr>
        <td><b>${x.name}</b></td><td>${x.wPct}%</td><td>${x.my}</td><td>${x.cls}</td>
        <td>${fmt(x.my*ww)}</td><td>${fmt(x.cls*ww)}</td>
      </tr>
    `;
  });

  return `
    <table>
      <thead>
        <tr>
          <th>Kalem</th><th>Ağırlık</th><th>Sen</th><th>Sınıf Ort</th><th>Katkın</th><th>Sınıf Katkısı</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

/* ---------- main ---------- */
function calculate(){
  const out=document.getElementById("out");
  out.innerHTML="";

  const myMid=num("inpMyMid");
  const clsMid=num("inpClsMid");
  const clsFinal=num("inpClsFinal");
  const wMidPct=num("inpWMid");
  const wFinalPct=num("inpWFinal");
  const N=num("inpN");
  const isMakeup=document.getElementById("inpIsMakeup").value === "1";
  const absent=document.getElementById("chkAbs").checked;
  const target=document.getElementById("inpTarget").value;

  const sigmaStr=txt("inpSigma");
  const sigmas = sigmaStr ? [Number(sigmaStr)] : SIGMA_DEFAULTS;

  // base validations
  if([myMid,clsMid,clsFinal].some(v=>!validate01(v))){
    out.innerHTML=`<div class="card warn">Uyarı: Vize, sınıf vize ort, sınıf final ort 0–100 arasında olmalı.</div>`;
    return;
  }
  if(!Number.isFinite(wMidPct)||!Number.isFinite(wFinalPct)||wMidPct<0||wFinalPct<0){
    out.innerHTML=`<div class="card warn">Uyarı: Ağırlıkları düzgün gir.</div>`;
    return;
  }
  if(!Number.isFinite(N) || N < 1){
    out.innerHTML=`<div class="card warn">Uyarı: N en az 1 olmalı.</div>`;
    return;
  }
  if(sigmas.some(s=>!Number.isFinite(s)||s<=0||s>50)){
    out.innerHTML=`<div class="card warn">Uyarı: σ 1–50 arasında olmalı.</div>`;
    return;
  }

  const extras = collectExtras();

  // extras validations + sum weights
  let sumPct = weightCheck(wMidPct,wFinalPct,extras);
  for(const x of extras){
    if(!Number.isFinite(Number(x.wPct))||x.wPct<0||x.wPct>100){
      out.innerHTML=`<div class="card warn">Uyarı: ${x.name}: ağırlık 0–100 olmalı.</div>`;
      return;
    }
    if(!validate01(Number(x.my))){
      out.innerHTML=`<div class="card warn">Uyarı: ${x.name}: senin notun 0–100 olmalı.</div>`;
      return;
    }
    if(!validate01(Number(x.cls))){
      out.innerHTML=`<div class="card warn">Uyarı: ${x.name}: sınıf ort 0–100 olmalı.</div>`;
      return;
    }
  }
  if(Math.round(sumPct*100)/100 !== 100){
    out.innerHTML=`<div class="card warn">Uyarı: Ağırlıkların toplamı <b>100</b> olmalı. Şu an: <b>${sumPct}</b></div>`;
    return;
  }

  const wMid = wMidPct/100;
  const wFinal = wFinalPct/100;
  const extrasN = extras.map(x=>({ ...x, w: (Number(x.wPct)||0)/100 }));

  const classConst = clsMid*wMid + extrasN.reduce((a,x)=>a + x.cls*x.w, 0);
  const userConst  = myMid*wMid  + extrasN.reduce((a,x)=>a + x.my*x.w, 0);

  const classAvg = classConst + clsFinal*wFinal; // X̄
  const system = decideSystem({isMakeup, N, classAvg});

  const sysText = (absent ? "—" : (system==="MDS" ? "MDS (Tablo-1)" : "BDS (Tablo-2 + koruma)"));

  let html = `
    <div class="card">
      <div class="pill"><b>Sistem:</b> ${sysText}</div>
      <div class="pill"><b>X̄ (Sınıf DSN Ort):</b> ${fmt(classAvg)}</div>
      <div class="pill"><b>N:</b> ${N}</div>
      <div class="pill"><b>Sınav:</b> ${isMakeup ? "Bütünleme" : "Final"}</div>
      <div class="muted" style="margin-top:8px">
        Not: KOÜ’de <b>Final/Büt &lt; ${EXAM_MIN}</b> ⇒ <b>FF</b>. Devamsız ⇒ <b>D</b>. DSN&lt;${BDS_DSN_MIN} ise BDS’ye katılmaz (bütünleme gerekir).
      </div>
      ${buildContributionTable({wMidPct,wFinalPct,myMid,clsMid,clsFinal,extras,wMid,wFinal})}
      <div class="muted" style="margin-top:10px"><b>Senin bilinen katkın (final hariç):</b> ${fmt(userConst)}</div>
    </div>
  `;

  if(absent){
    out.innerHTML = html + `<div class="card bad"><b>Sonuç:</b> Devamsız (D). Hedef final hesaplanamaz.</div>`;
    return;
  }

  // MDS hedefi: DSN eşiklerine göre final bulunur (σ önemsiz)
  if(system === "MDS"){
    const needDSNMin = (()=>{
      // hedef harfin alt sınırı (Tablo-1)
      switch(target){
        case "AA": return 90;
        case "BA": return 80;
        case "BB": return 75;
        case "CB": return 70;
        case "CC": return 60;
        case "DC": return 50;
        case "DD": return 40;
        case "FD": return 30;
        case "FF": return 0;
        default: return 60;
      }
    })();

    // DSN = userConst + final*wFinal >= needDSNMin
    let req = (needDSNMin - userConst) / wFinal;
    req = Math.ceil(req * 100) / 100; // 2dp yukarı yuvarla

    // KOÜ baraj
    req = Math.max(EXAM_MIN, req);

    if(req > 100){
      out.innerHTML = html + `<div class="card bad"><b>Hedef:</b> ${target} → gereken final: <b>İMKANSIZ</b> (100 üstü)</div>`;
      return;
    }

    const dsn = userConst + req*wFinal;
    const L = table1Letter(dsn);

    out.innerHTML = html + `
      <div class="card ok">
        <div><b>MDS hedefi:</b> ${target}</div>
        <div>Gereken minimum final/büt: <b>${req.toFixed(2)}</b> (baraj dahil)</div>
        <div class="muted">Bu final ile DSN ≈ <b>${fmt(dsn)}</b> → Tablo-1 harf: <b>${L}</b></div>
      </div>
    `;
    return;
  }

  // BDS: σ senaryoları
  html += `<div class="card"><b>BDS modundayız.</b> Hedef harf için 40–100 aralığında en küçük final aranır.</div>`;

  for(const s of sigmas){
    const r = minFinalForTarget({
      targetLetter: target,
      absent:false,
      classAvg,
      system:"BDS",
      sigma:s,
      wFinal,
      userConst
    });

    if(!r.ok){
      html += `<div class="card bad"><b>σ = ${s}</b> → <b>İMKANSIZ</b> • <span class="muted">${r.reason}</span></div>`;
      continue;
    }

    const det = r.detail;
    const detailLine = (Number.isFinite(det.t))
      ? `Z=${fmt(det.z)} • T=${fmt(det.t)} • Düzey=${det.level} • Tablo-2=${det.raw} • Tablo-1 alt sınır=${det.base}`
      : det.note;

    html += `
      <div class="card ok">
        <div><b>σ = ${s}</b> → gereken minimum final: <b>${r.fin.toFixed(2)}</b></div>
        <div class="muted">Bu final ile DSN ≈ <b>${fmt(r.dsn)}</b> → Harf: <b>${det.letter}</b> • ${det.note}</div>
        <div class="muted">${detailLine}</div>
      </div>
    `;
  }

  out.innerHTML = html;
}
</script>
</body>
</html>
