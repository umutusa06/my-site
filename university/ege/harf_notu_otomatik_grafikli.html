<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ege Üniversitesi - Harf Notu (BDS/DDS) + Grafik</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Manrope:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b132b;
      --bg2:#111b33;
      --card:#0f172a;
      --glass:rgba(255,255,255,0.03);
      --accent:#f7b733;
      --accent2:#21e6c1;
      --border:#1f2a44;
      --text:#e8eefb;
      --muted:#9fb1d1;
    }
    .shell{max-width:1100px;margin:0 auto;padding:24px 18px 30px;}
    nav.nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
    nav.nav a{color:var(--text);text-decoration:none;padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,0.05);font-weight:800;transition:background .15s ease,border-color .15s ease,color .15s ease}
    nav.nav a.active{border-color:var(--accent);color:var(--accent);background:rgba(247,183,51,0.12);}
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:28px 18px 34px;
      font-family:"Space Grotesk","Manrope",system-ui,-apple-system,sans-serif;
      background:radial-gradient(circle at 20% 18%, rgba(33,230,193,0.16), transparent 32%),
                 radial-gradient(circle at 82% 8%, rgba(247,183,51,0.16), transparent 32%),
                 linear-gradient(145deg, var(--bg), var(--bg2));
      color:var(--text);
      line-height:1.6;
    }
    .container{
      max-width:1100px;
      margin:auto;
      background:var(--glass);
      border:1px solid var(--border);
      border-radius:18px;
      padding:22px;
      box-shadow:0 18px 50px rgba(0,0,0,0.28);
    }
    h2{
      text-align:center;
      color:var(--accent);
      margin:0 0 6px;
      letter-spacing:-0.4px;
    }
    .bar{display:flex;flex-wrap:wrap;align-items:center;gap:10px;justify-content:space-between;margin-bottom:10px}
    .selectWrap{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:700;font-size:14px}
    select.uni{
      width:auto;
      min-width:220px;
      padding:9px 12px;
      border-radius:10px;
      background:rgba(255,255,255,0.05);
      border:1px solid var(--border);
      color:var(--text);
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .full{grid-column:1/-1}
    label{font-weight:700;display:block;margin-top:6px;color:var(--text);font-size:14px}
    input,select,button{
      width:100%;
      padding:11px 12px;
      margin-top:6px;
      box-sizing:border-box;
      font-size:15px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.04);
      color:var(--text);
    }
    input:focus,select:focus{
      outline:none;
      border-color:var(--accent2);
      box-shadow:0 0 0 3px rgba(33,230,193,0.2);
    }
    button{
      background:linear-gradient(120deg,var(--accent),#f37335);
      color:#0b0c10;
      border:none;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      margin-top:16px;
      box-shadow:0 12px 30px rgba(243,115,53,0.25);
      transition:transform .18s ease, box-shadow .18s ease;
    }
    button:hover{transform:translateY(-2px);box-shadow:0 16px 36px rgba(243,115,53,0.32);}
    .card{
      background:rgba(255,255,255,0.03);
      border:1px solid var(--border);
      border-left:6px solid var(--accent2);
      border-radius:14px;
      padding:12px;
      margin-top:12px;
    }
    .warn{background:rgba(247,183,51,0.08);border-left-color:#f59e0b;}
    .mutlak{background:rgba(255,255,255,0.02);border-left-color:#111827;}
    .good{border-left-color:#16a34a;}
    .low{border-left-color:#17a2b8;}
    .mid{border-left-color:#28a745;}
    .high{border-left-color:#dc3545;}
    .muted{font-size:12px;color:var(--muted);margin-top:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:rgba(255,255,255,0.02);border-radius:10px;overflow:hidden}
    th,td{border-bottom:1px solid var(--border);padding:8px;font-size:14px;text-align:left;color:var(--text)}
    th{color:var(--muted);font-weight:700;}
    .charts{display:grid;grid-template-columns:1fr;gap:16px;margin-top:18px}
    @media (min-width: 980px){
      .charts{grid-template-columns:1fr 1fr}
      .charts .fullchart{grid-column:1/-1}
    }
    .chartCard{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      box-shadow:0 12px 28px rgba(0,0,0,0.25);
    }
    .chartTitle{font-weight:800;margin-bottom:8px;color:var(--text)}
    canvas{width:100%;height:320px;display:block;border-radius:12px;background:#0f172a}
    .legend{font-size:12px;color:var(--muted);margin-top:8px;display:flex;gap:10px;flex-wrap:wrap}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,0.05);border:1px solid var(--border)}
    .dot{width:10px;height:10px;border-radius:50%;}
    .checkRow{display:flex;align-items:center;gap:10px;margin-top:10px}
    .extraWrap{margin-top:10px}
    .extraGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    .extraTitle{font-weight:900;margin-bottom:6px}
    @media(max-width:680px){.row{grid-template-columns:1fr;}}
  </style>
</head>
<body>
<div class="shell">
  <nav class="nav">
    <a href="index.html">Ana Sayfa</a>
    <a class="active" href="harf_notu_otomatik_grafikli.html">Harf Notu + Grafik</a>
    <a href="heatmap.html">Heatmap</a>
    <a href="detaylifinal.html">Hedef Final</a>
    <a href="anogano.html">AGNO / GANO</a>
    <a href="hakkinda.html">Hakkında</a>
  </nav>

<div class="container">
  <div class="bar">
    <div>
      <h2>Ege Üniversitesi - Harf Notu (BDS/DDS) + Grafik</h2>
      <div class="muted" id="uniNote"></div>
    </div>
  </div>

  <div class="row">
    <div>
      <label>Vize Notun</label>
      <input id="inpMyMid" type="number" min="0" max="100" placeholder="0-100">
    </div>
    <div>
      <label>Final Notun</label>
      <input id="inpMyFinal" type="number" min="0" max="100" placeholder="0-100">
      <div class="muted" id="finalBarajNote">Final alt limiti (FSAL): <b>45</b> (45 altı otomatik <b>FD</b>)</div>
    </div>

    <div>
      <label>Sınıf Vize Ortalaması</label>
      <input id="inpClsMid" type="number" min="0" max="100" placeholder="0-100">
    </div>
    <div>
      <label>Sınıf Final Ortalaması</label>
      <input id="inpClsFinal" type="number" min="0" max="100" placeholder="0-100">
    </div>

    <div>
      <label>Değerlendirmeye Alınan Öğrenci Sayısı (N)</label>
      <input id="inpN" type="number" min="1" step="1" placeholder="örn. 35">
      <div class="muted">Madde 33: N ≤ 29 → Tablo 2; N ≥ 30 → t-skor (Tablo 4).</div>
    </div>

    <div>
      <label>Vize Ağırlığı (%)</label>
      <input id="inpWMid" type="number" min="0" max="100" value="40">
    </div>
    <div>
      <label>Final Ağırlığı (%)</label>
      <input id="inpWFinal" type="number" min="0" max="100" value="60">
      <div class="muted">Ek kalem varsa toplam ağırlık yine 100 olmalı.</div>
    </div>

    <div class="full">
      <div class="checkRow">
        <input id="chkExtra" type="checkbox" style="width:auto;transform:scale(1.1)">
        <label for="chkExtra" style="margin:0;font-weight:900">Ek değerlendirme var (ödev/quiz/proje/lab...)</label>
      </div>
    </div>

    <div id="extraArea" class="full" style="display:none">
      <label>Kaç adet ek kalem?</label>
      <select id="inpExtraCount">
        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
      </select>
      <div class="muted">Her ek kalem için: Ad, ağırlık %, senin notun, sınıf ortalaması</div>
      <div id="extraList" class="extraWrap"></div>
    </div>

    <div class="full">
      <label>Sınıf HBP Standart Sapması (σ) <span class="muted">(N≥30 ve sınıf düzeyi Mükemmel değilse gerekli)</span></label>
      <input id="inpSigma" type="number" min="0.1" step="0.1" placeholder="bilmiyorsan boş bırak → σ 5.0–25.0 (0.1 adım) simülasyon">
    </div>

    <div class="full">
      <button id="btnCalc" type="button" onclick="hesapla()">Hesapla + Grafik Çiz</button>
    </div>
  </div>

  <div id="out"></div>

  <div id="chartArea" class="charts" style="display:none;">
    <div class="chartCard">
      <div class="chartTitle">Final notu vs Harf notu (EÜ)</div>
      <canvas id="cvFinalVsLetter"></canvas>
      <div class="legend" id="legendFinalVs"></div>
      <div class="muted">Ek kalemler sabit kabul edilip final 45-100 taranır (FSAL=45).</div>
    </div>

    <div class="chartCard">
      <div class="chartTitle">σ değişince harf nasıl değişiyor? (EÜ BDS)</div>
      <canvas id="cvSigmaVsLetter"></canvas>
      <div class="muted">Final sabit: girdiğin final. σ 5.0–25.0 aralığında (0.1 adım) simüle edilir.</div>
    </div>

    <div class="chartCard fullchart">
      <div class="chartTitle">Z-T grafiği (T = 60 + 10Z)</div>
      <canvas id="cvZT"></canvas>
      <div class="muted">Seçilen σ ile senin noktan (Z,T) işaretlenir. σ boşsa 15 ile gösterilir.</div>
    </div>
  </div>
</div>

<script>
/* -------------------------------------------------------------
   EGE ÜNİVERSİTESİ — Ölçme & Değerlendirme Esasları (BDS/DDS)
   Kaynak: "Ölçme ve Değerlendirme Esasları Yönergesi"
   ------------------------------------------------------------- */

/* ---------- UI refs ---------- */
const chkExtra = document.getElementById("chkExtra");
const extraArea = document.getElementById("extraArea");
const inpExtraCount = document.getElementById("inpExtraCount");
const extraList = document.getElementById("extraList");
const uniNote = document.getElementById("uniNote");
const btnCalc = document.getElementById("btnCalc");
const finalBarajNote = document.getElementById("finalBarajNote");
const out = document.getElementById("out");

/* ---------- Constants (EÜ) ---------- */
const EGE = {
  name: "Ege Üniversitesi",
  FSAL: 45,   // Final sınavı alt limiti
  HBPAL: 40,  // Ham başarı puanı alt limiti
  OKAL: 15,   // Ortalamaya katma alt limiti (ortalama hesabı)
  // YİPKY: %40–70 ; YSPKY: %60–30  (toplam 100)
  allowedFinalWeight: { min: 30, max: 60 },
  allowedInTermWeight: { min: 40, max: 70 }
};

const LETTERS = ["AA","BA","BB","CB","CC","DC","DD","FD"]; // grafik sırası (yüksek → düşük)
function letterIndex(L){ return LETTERS.indexOf(L); }
function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

function roundHBP(x){
  // Madde 6: ondalık kısmı 0.50 ve üzeri → üst tam sayıya, değilse alt tam sayıya.
  const f = Math.floor(x);
  const frac = x - f;
  return (frac >= 0.5) ? f + 1 : f;
}
function round2(x){ return Math.round(x * 100) / 100; }

/* ---------- Tablo 2: HBP → Harf (DDS ve bazı BDS durumları) ---------- */
function letterFromHBP(hbp){
  // Uygulamada 0–100 aralığı için kapsayıcı aralıklar kullanılır.
  if(hbp >= 88) return "AA";
  if(hbp >= 81) return "BA";
  if(hbp >= 74) return "BB";
  if(hbp >= 67) return "CB";
  if(hbp >= 60) return "CC";
  if(hbp >= 53) return "DC";
  if(hbp >= 46) return "DD";
  return "FD";
}

/* ---------- Tablo 3: HBPO → Sınıf düzeyi ---------- */
function classLevelFromHBPO(hbpo){
  // Alt ve üst sınırlar ilgili düzeye DAHİL (Yönerge notu).
  if(hbpo >= 70.00 && hbpo <= 100.00) return "Mükemmel";
  if(hbpo >= 62.50 && hbpo <= 69.99) return "Çok İyi";
  if(hbpo >= 57.50 && hbpo <= 62.49) return "İyi";
  if(hbpo >= 52.50 && hbpo <= 57.49) return "Orta Üstü";
  if(hbpo >= 47.50 && hbpo <= 52.49) return "Orta";
  if(hbpo >= 42.50 && hbpo <= 47.49) return "Zayıf";
  return "Kötü"; // 0.00–42.49
}

/* ---------- Tablo 4: (Sınıf düzeyi ≠ Mükemmel) t-skor → Harf ---------- */
const T_THRESHOLDS = {
  "Çok İyi":   { AA:71, BA:66, BB:61, CB:56, CC:51, DC:46, DD:41 },
  "İyi":      { AA:73, BA:68, BB:63, CB:58, CC:53, DC:48, DD:43 },
  "Orta Üstü": { AA:75, BA:70, BB:65, CB:60, CC:55, DC:50, DD:45 },
  "Orta":     { AA:77, BA:72, BB:67, CB:62, CC:57, DC:52, DD:47 },
  "Zayıf":    { AA:79, BA:74, BB:69, CB:64, CC:59, DC:54, DD:49 },
  "Kötü":     { AA:81, BA:76, BB:71, CB:66, CC:61, DC:56, DD:51 }
};

function letterFromT(level, t){
  const thr = T_THRESHOLDS[level];
  if(!thr) return null;
  if(t >= thr.AA) return "AA";
  if(t >= thr.BA) return "BA";
  if(t >= thr.BB) return "BB";
  if(t >= thr.CB) return "CB";
  if(t >= thr.CC) return "CC";
  if(t >= thr.DC) return "DC";
  if(t >= thr.DD) return "DD";
  return "FD";
}

/* ---------- Extras UI ---------- */
chkExtra.addEventListener("change", ()=>{
  extraArea.style.display = chkExtra.checked ? "block" : "none";
  renderExtras();
});
inpExtraCount.addEventListener("change", renderExtras);

function renderExtras(){
  extraList.innerHTML = "";
  if(!chkExtra.checked) return;
  const n = Number(inpExtraCount.value);
  for(let i=1;i<=n;i++){
    const div = document.createElement("div");
    div.className = "extraRow";
    div.innerHTML = `
      <div class="grid4">
        <div>
          <label>Ad</label>
          <input id="exName${i}" type="text" placeholder="Ödev / Quiz / Lab...">
        </div>
        <div>
          <label>Ağırlık (%)</label>
          <input id="exW${i}" type="number" min="0" max="100" placeholder="0-100">
        </div>
        <div>
          <label>Senin Notun</label>
          <input id="exMy${i}" type="number" min="0" max="100" placeholder="0-100">
        </div>
        <div>
          <label>Sınıf Ortalaması</label>
          <input id="exCls${i}" type="number" min="0" max="100" placeholder="0-100">
        </div>
      </div>`;
    extraList.appendChild(div);
  }
}

function readExtras(){
  if(!chkExtra.checked) return [];
  const n = Number(inpExtraCount.value);
  const arr = [];
  for(let i=1;i<=n;i++){
    arr.push({
      name: (document.getElementById(`exName${i}`).value || `Ek ${i}`).trim(),
      wPct: Number(document.getElementById(`exW${i}`).value),
      my: Number(document.getElementById(`exMy${i}`).value),
      cls: Number(document.getElementById(`exCls${i}`).value)
    });
  }
  return arr;
}

/* ---------- Data & totals ---------- */
function collectData(){
  return {
    myMid: Number(document.getElementById("inpMyMid").value),
    myFinal: Number(document.getElementById("inpMyFinal").value),
    clsMid: Number(document.getElementById("inpClsMid").value),
    clsFinal: Number(document.getElementById("inpClsFinal").value),
    wMidPct: Number(document.getElementById("inpWMid").value),
    wFinalPct: Number(document.getElementById("inpWFinal").value),
    nStr: (document.getElementById("inpN").value || "").trim(),
    sigmaStr: (document.getElementById("inpSigma").value || "").trim(),
    extras: readExtras()
  };
}

function computeTotals(d){
  const wMid = d.wMidPct/100;
  const wFinal = d.wFinalPct/100;
  const extrasN = d.extras.map(ex => ({...ex, w: ex.wPct/100}));

  const myRaw = d.myMid*wMid + d.myFinal*wFinal + extrasN.reduce((a,x)=>a + x.my*x.w, 0);
  const clsRaw = d.clsMid*wMid + d.clsFinal*wFinal + extrasN.reduce((a,x)=>a + x.cls*x.w, 0);

  return { myRaw, clsRaw, wMid, wFinal, extrasN };
}

function validateData(d){
  const nums = [d.myMid, d.myFinal, d.clsMid, d.clsFinal];
  if(nums.some(v => !Number.isFinite(v) || v<0 || v>100)) return "Vize/Final ve sınıf ortalamaları 0-100 arasında olmalı.";
  if(!Number.isFinite(d.wMidPct) || !Number.isFinite(d.wFinalPct)) return "Ağırlıkları düzgün gir.";
  if(d.wMidPct<0 || d.wFinalPct<0) return "Ağırlıklar negatif olamaz.";

  const n = d.nStr ? Number(d.nStr) : NaN;
  if(!Number.isFinite(n) || n<1 || Math.floor(n)!==n) return "Öğrenci sayısı (N) en az 1 olmalı ve tam sayı olmalı.";

  let total = d.wMidPct + d.wFinalPct;
  for(const ex of d.extras){
    if(!Number.isFinite(ex.wPct)||ex.wPct<0||ex.wPct>100) return `${ex.name}: ağırlık 0-100 olmalı.`;
    if(!Number.isFinite(ex.my)||ex.my<0||ex.my>100) return `${ex.name}: senin notun 0-100 olmalı.`;
    if(!Number.isFinite(ex.cls)||ex.cls<0||ex.cls>100) return `${ex.name}: sınıf ortalaması 0-100 olmalı.`;
    total += ex.wPct;
  }
  if(Math.abs(total - 100) > 0.01) return `Toplam ağırlık %100 olmalı. Şu an: %${total.toFixed(2)}.`;

  if(d.sigmaStr){
    const s = Number(d.sigmaStr);
    if(!Number.isFinite(s) || s<=0 || s>50) return "σ (standart sapma) 0-50 arasında olmalı.";
  }
  return null;
}

/* ---------- Evaluation (EÜ rules) ---------- */
function evaluateEge(d, totals, sigmaOverride){
  const N = Number(d.nStr);
  const sigma = (sigmaOverride != null) ? Number(sigmaOverride) : (d.sigmaStr ? Number(d.sigmaStr) : null);

  const myHbp = roundHBP(totals.myRaw);
  const hbpo = round2(totals.clsRaw); // yaklaşık HBPO (verilen sınıf ortalamalarından)
  const level = classLevelFromHBPO(hbpo);

  // Önce barajlar:
  if(d.myFinal < EGE.FSAL){
    return { N, sigma, myHbp, hbpo, level, z:null, t:null, letter:"FD", method:"FSAL", reason:`Final < ${EGE.FSAL} → FD` };
  }
  if(myHbp < EGE.HBPAL){
    return { N, sigma, myHbp, hbpo, level, z:null, t:null, letter:"FD", method:"HBPAL", reason:`HBP < ${EGE.HBPAL} → FD` };
  }

  // Madde 33:
  if(N <= 29){
    return { N, sigma, myHbp, hbpo, level, z:null, t:null, letter:letterFromHBP(myHbp), method:"Tablo 2 (N≤29)", reason:"N≤29 → HBP üzerinden Tablo 2" };
  }

  // N ≥ 30
  if(level === "Mükemmel"){
    return { N, sigma, myHbp, hbpo, level, z:null, t:null, letter:letterFromHBP(myHbp), method:"Tablo 2 (Mükemmel)", reason:"Sınıf düzeyi Mükemmel → Tablo 2" };
  }

  // Sınıf düzeyi mükemmel değilse: z, t ve Tablo 4
  if(!sigma){
    return { N, sigma:null, myHbp, hbpo, level, z:null, t:null, letter:null, method:"Tablo 4", reason:"σ girilmeden t-skor/harf hesaplanamaz." };
  }
  const z = (myHbp - hbpo) / sigma;
  const t = 60 + z*10;
  const letter = letterFromT(level, t);
  return { N, sigma, myHbp, hbpo, level, z:round2(z), t:round2(t), letter, method:"Tablo 4 (t-skor)", reason:"N≥30 ve sınıf düzeyi ≠ Mükemmel → t-skor" };
}

/* ---------- Canvas helpers (minimal) ---------- */
function setupCanvas(canvas){
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return ctx;
}
function clear(ctx, W, H){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle="#0f172a";
  ctx.fillRect(0,0,W,H);
}
function drawText(ctx, x, y, txt, align="left"){
  ctx.fillStyle="#e5e7eb";
  ctx.font="12px Manrope, sans-serif";
  ctx.textAlign=align;
  ctx.fillText(txt, x, y);
  ctx.textAlign="left";
}
function drawAxes(ctx, plot, xlabel, ylabel){
  ctx.strokeStyle="#1f2937"; ctx.lineWidth=1.2;
  ctx.beginPath(); ctx.moveTo(plot.x0, plot.y1); ctx.lineTo(plot.x1, plot.y1); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(plot.x0, plot.y0); ctx.lineTo(plot.x0, plot.y1); ctx.stroke();
  drawText(ctx, (plot.x0+plot.x1)/2, plot.y1+26, xlabel, "center");
  ctx.save();
  ctx.translate(plot.x0-28, (plot.y0+plot.y1)/2);
  ctx.rotate(-Math.PI/2);
  drawText(ctx, 0, 0, ylabel, "center");
  ctx.restore();
}
function xScale(x, xmin, xmax, plot){
  return plot.x0 + (x - xmin) * (plot.x1-plot.x0) / (xmax - xmin);
}
function yForLetter(L, plot){
  const idx = letterIndex(L);
  const n = LETTERS.length;
  const step = (plot.y1 - plot.y0) / (n-1);
  return plot.y0 + idx * step;
}
function drawStepLine(ctx, pts){
  if(pts.length<2) return;
  ctx.strokeStyle="#e5e7eb"; ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=1;i<pts.length;i++){
    // step: horizontal then vertical
    ctx.lineTo(pts[i].x, pts[i-1].y);
    ctx.lineTo(pts[i].x, pts[i].y);
  }
  ctx.stroke();
}
function drawPoint(ctx, x, y){
  ctx.fillStyle="#22c55e";
  ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
}

/* ---------- Charts ---------- */
function drawFinalVsLetter(d, totals){
  const canvas = document.getElementById("cvFinalVsLetter");
  const ctx = setupCanvas(canvas);
  const W = canvas.clientWidth, H = canvas.clientHeight;
  clear(ctx,W,H);

  const plot = { x0:52, y0:20, x1:W-16, y1:H-44 };
  drawAxes(ctx, plot, "Final", "Harf");

  // y-ticks as letters
  for(const L of LETTERS){
    const y = yForLetter(L, plot);
    ctx.strokeStyle="#111827"; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(plot.x0, y); ctx.lineTo(plot.x1, y); ctx.stroke();
    drawText(ctx, plot.x0-8, y+4, L, "right");
  }

  const xmin = EGE.FSAL, xmax = 100;
  const sigmaForPlot = d.sigmaStr ? Number(d.sigmaStr) : 15;

  const pts = [];
  for(let f=xmin; f<=xmax; f+=1){
    const d2 = {...d, myFinal:f};
    const totals2 = computeTotals(d2);
    const r = evaluateEge(d2, totals2, sigmaForPlot);
    const L = r.letter || "FD";
    pts.push({ x:xScale(f,xmin,xmax,plot), y:yForLetter(L,plot) });
  }
  drawStepLine(ctx, pts);

  // Mark user's point
  const r0 = evaluateEge(d, totals, sigmaForPlot);
  if(r0.letter){
    const x = xScale(d.myFinal, xmin, xmax, plot);
    const y = yForLetter(r0.letter, plot);
    drawPoint(ctx,x,y);
  }
}

function drawSigmaVsLetter(d, totals){
  const canvas = document.getElementById("cvSigmaVsLetter");
  const ctx = setupCanvas(canvas);
  const W = canvas.clientWidth, H = canvas.clientHeight;
  clear(ctx,W,H);

  const plot = { x0:52, y0:20, x1:W-16, y1:H-44 };
  drawAxes(ctx, plot, "σ", "Harf");

  for(const L of LETTERS){
    const y = yForLetter(L, plot);
    ctx.strokeStyle="#111827"; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(plot.x0, y); ctx.lineTo(plot.x1, y); ctx.stroke();
    drawText(ctx, plot.x0-8, y+4, L, "right");
  }

  const xmin=5.0, xmax=25.0;
  const pts=[];
  for(let s=xmin; s<=xmax+1e-9; s+=0.1){
    const sigma = Math.round(s*10)/10;
    const r = evaluateEge(d, totals, sigma);
    const L = r.letter || "FD";
    pts.push({ x:xScale(sigma,xmin,xmax,plot), y:yForLetter(L,plot) });
  }
  drawStepLine(ctx, pts);

  // mark chosen sigma if any
  const sigmaForPoint = d.sigmaStr ? Number(d.sigmaStr) : 15;
  const r0 = evaluateEge(d, totals, sigmaForPoint);
  if(r0.letter){
    drawPoint(ctx, xScale(sigmaForPoint,xmin,xmax,plot), yForLetter(r0.letter,plot));
  }
}

function drawZT(d, totals){
  const canvas = document.getElementById("cvZT");
  const ctx = setupCanvas(canvas);
  const W = canvas.clientWidth, H = canvas.clientHeight;
  clear(ctx,W,H);

  const plot = { x0:52, y0:20, x1:W-16, y1:H-44 };
  drawAxes(ctx, plot, "Z", "T");

  const zmin=-3, zmax=3;
  const tAt = (z)=> 60 + 10*z;
  // grid
  ctx.strokeStyle="#111827"; ctx.lineWidth=1;
  for(let z=-3; z<=3; z+=1){
    const x = xScale(z,zmin,zmax,plot);
    ctx.beginPath(); ctx.moveTo(x, plot.y0); ctx.lineTo(x, plot.y1); ctx.stroke();
    drawText(ctx, x, plot.y1+16, String(z), "center");
  }
  for(let t=30; t<=90; t+=10){
    const y = plot.y1 - (t-30)*(plot.y1-plot.y0)/(90-30);
    ctx.beginPath(); ctx.moveTo(plot.x0, y); ctx.lineTo(plot.x1, y); ctx.stroke();
    drawText(ctx, plot.x0-8, y+4, String(t), "right");
  }

  // line
  ctx.strokeStyle="#e5e7eb"; ctx.lineWidth=2;
  ctx.beginPath();
  for(let z=zmin; z<=zmax+1e-9; z+=0.05){
    const x = xScale(z,zmin,zmax,plot);
    const t = tAt(z);
    const y = plot.y1 - (t-30)*(plot.y1-plot.y0)/(90-30);
    if(z===zmin) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  const sigmaForPoint = d.sigmaStr ? Number(d.sigmaStr) : 15;
  const r0 = evaluateEge(d, totals, sigmaForPoint);
  if(r0.z!=null && r0.t!=null){
    const x = xScale(r0.z, zmin, zmax, plot);
    const y = plot.y1 - (r0.t-30)*(plot.y1-plot.y0)/(90-30);
    drawPoint(ctx,x,y);
  }
}

/* ---------- Main ---------- */
function hesapla(){
  const d = collectData();
  const err = validateData(d);
  if(err){
    out.innerHTML = `<div class="card bad"><b>Hata:</b> ${err}</div>`;
    document.getElementById("chartArea").style.display="none";
    return;
  }

  // UI notes
  uniNote.textContent = `${EGE.name} yönergesine göre (BDS/DDS) hesaplama. FSAL=${EGE.FSAL}, HBPAL=${EGE.HBPAL}.`;

  // Weight rule warning (Madde 5)
  const inTermWeight = d.wMidPct + d.extras.reduce((a,x)=>a+x.wPct,0);
  const wWarn = [];
  if(d.wFinalPct < EGE.allowedFinalWeight.min || d.wFinalPct > EGE.allowedFinalWeight.max){
    wWarn.push(`Final ağırlığı normalde %${EGE.allowedFinalWeight.min}–%${EGE.allowedFinalWeight.max} aralığında olmalı.`);
  }
  if(inTermWeight < EGE.allowedInTermWeight.min || inTermWeight > EGE.allowedInTermWeight.max){
    wWarn.push(`Yarıyıl içi toplam ağırlık normalde %${EGE.allowedInTermWeight.min}–%${EGE.allowedInTermWeight.max} aralığında olmalı.`);
  }

  // FSAL note
  finalBarajNote.innerHTML = `Final alt limiti (FSAL): <b>${EGE.FSAL}</b> (${EGE.FSAL} altı otomatik <b>FD</b>)`;

  const totals = computeTotals(d);
  const r = evaluateEge(d, totals, null);

  let html = "";
  if(wWarn.length){
    html += `<div class="card warn"><b>Uyarı (Ağırlık Kuralı)</b><div class="muted">${wWarn.join(" ")}</div></div>`;
  }

  html += `<div class="card good">
    <b>Hesap Özeti</b><br>
    Senin ham başarı puanın (HBP): <b>${r.myHbp}</b><br>
    Sınıf HBP ortalaması (HBPO, yaklaşık): <b>${r.hbpo.toFixed(2)}</b><br>
    Sınıf düzeyi (Tablo 3): <b>${r.level}</b><br>
    Yöntem: <b>${r.method}</b>
    <div class="muted">${r.reason}</div>
  </div>`;

  if(r.z!=null && r.t!=null){
    html += `<div class="card">
      <b>T-skor detay</b><br>
      σ: <b>${r.sigma}</b> — z: <b>${r.z.toFixed(2)}</b> — t: <b>${r.t.toFixed(2)}</b><br>
      Harf notu: <b>${r.letter}</b>
    </div>`;
  } else if(r.letter){
    html += `<div class="card">
      <b>Harf notu</b>: <b>${r.letter}</b>
    </div>`;
  } else {
    // Sınıf düzeyi Mükemmel değilse Tablo 4 (t-skor) için σ gerekir.
    // σ girilmediyse: 5.0–25.0 aralığında 0.1 adım ile tarayıp harf notu olasılıklarını hesapla.
    const counts = {};
    let n = 0;
    for(let s=5.0; s<=25.0+1e-9; s+=0.1){
      const sigma = Math.round(s*10)/10;
      const rr = evaluateEge(d, totals, sigma);
      const L = rr.letter || "FD";
      counts[L] = (counts[L]||0) + 1;
      n++;
    }

    const rows = LETTERS.filter(L=>counts[L]).map(L=>{
      const p = (counts[L]/n)*100;
      return `<tr><td><b>${L}</b></td><td>${p.toFixed(1)}%</td></tr>`;
    }).join("");

    const summary = LETTERS.filter(L=>counts[L]).map(L=>{
      const p = (counts[L]/n)*100;
      return `${L}: ${p.toFixed(1)}%`;
    }).join(" • ");

    html += `<div class="card warn">
      <b>Standart sapma (σ) gerekli</b>
      <div class="muted">N≥30 ve sınıf düzeyi <b>${r.level}</b> olduğunda (Mükemmel değilse) t‑skor (Tablo 4) ile harf notu hesaplamak için σ gerekir. σ değerini girersen sonuç tek bir harf notu olarak hesaplanır.</div>
    </div>`;

    html += `<div class="card">
      <b>σ girilmedi: Harf notu olasılıkları</b>
      <div class="muted">σ 5.0–25.0 aralığında 0.1 adım ile tarandı (tüm σ değerleri eşit ağırlıklı).</div>
      <table>
        <thead><tr><th>Harf</th><th>Olasılık</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="muted"><b>Özet:</b> ${summary}</div>
      <div class="muted">Not: Bu çıktı σ bilinmediğinde kaba bir aralık taramasıdır; resmi sonuç için dersin HBPO ve σ değerleri gerekir.</div>
    </div>`;
  }

  out.innerHTML = html;

  // Charts
  document.getElementById("chartArea").style.display="grid";
  drawFinalVsLetter(d, totals);
  drawSigmaVsLetter(d, totals);
  drawZT(d, totals);
}

function init(){
  uniNote.textContent = `${EGE.name} yönergesine göre (BDS/DDS) hesaplama.`;
  btnCalc.textContent = "Hesapla + Grafik Çiz";
  btnCalc.disabled = false;
  finalBarajNote.innerHTML = `Final alt limiti (FSAL): <b>${EGE.FSAL}</b> (${EGE.FSAL} altı otomatik <b>FD</b>)`;

  // Varsayılan ağırlıklar
  document.getElementById("inpWMid").value = 40;
  document.getElementById("inpWFinal").value = 60;

  // placeholder
  document.getElementById("inpSigma").placeholder = "örn. 12.3 (N≥30 ve sınıf düzeyi Mükemmel değilse gerekli)";

  renderExtras();
}

window.addEventListener("resize", ()=>{
  const chartArea = document.getElementById("chartArea");
  if(chartArea.style.display !== "none"){
    try{ hesapla(); }catch(e){}
  }
});

init();
</script>
</div>
</body>
</html>
