<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Akdeniz Üniversitesi • Harf Notu (Ek Kalem + Grafik)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Manrope:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b132b;
      --bg2:#111b33;
      --card:#0f172a;
      --glass:rgba(255,255,255,0.03);
      --accent:#f7b733;
      --accent2:#21e6c1;
      --border:#1f2a44;
      --text:#e8eefb;
      --muted:#9fb1d1;
    }
    .shell{max-width:1100px;margin:0 auto;padding:24px 18px 30px;}
    nav.nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
    nav.nav a{color:var(--text);text-decoration:none;padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,0.05);font-weight:800;transition:background .15s ease,border-color .15s ease,color .15s ease}
    nav.nav a.active{border-color:var(--accent);color:var(--accent);background:rgba(247,183,51,0.12);}
    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:28px 18px 34px;
      font-family:"Space Grotesk","Manrope",system-ui,-apple-system,sans-serif;
      background:radial-gradient(circle at 20% 18%, rgba(33,230,193,0.16), transparent 32%),
                 radial-gradient(circle at 82% 8%, rgba(247,183,51,0.16), transparent 32%),
                 linear-gradient(145deg, var(--bg), var(--bg2));
      color:var(--text);
      line-height:1.6;
    }
    .container{
      max-width:1100px;
      margin:auto;
      background:var(--glass);
      border:1px solid var(--border);
      border-radius:18px;
      padding:22px;
      box-shadow:0 18px 50px rgba(0,0,0,0.28);
    }
    h2{
      text-align:center;
      color:var(--accent);
      margin:0 0 6px;
      letter-spacing:-0.4px;
    }
    .bar{display:flex;flex-wrap:wrap;align-items:center;gap:10px;justify-content:space-between;margin-bottom:10px}
    .selectWrap{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:700;font-size:14px}
    select.uni{
      width:auto;
      min-width:220px;
      padding:9px 12px;
      border-radius:10px;
      background:rgba(255,255,255,0.05);
      border:1px solid var(--border);
      color:var(--text);
    }
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .full{grid-column:1/-1}
    label{font-weight:700;display:block;margin-top:6px;color:var(--text);font-size:14px}
    input,select,button{
      width:100%;
      padding:11px 12px;
      margin-top:6px;
      box-sizing:border-box;
      font-size:15px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.04);
      color:var(--text);
    }
    input:focus,select:focus{
      outline:none;
      border-color:var(--accent2);
      box-shadow:0 0 0 3px rgba(33,230,193,0.2);
    }
    button{
      background:linear-gradient(120deg,var(--accent),#f37335);
      color:#0b0c10;
      border:none;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      margin-top:16px;
      box-shadow:0 12px 30px rgba(243,115,53,0.25);
      transition:transform .18s ease, box-shadow .18s ease;
    }
    button:hover{transform:translateY(-2px);box-shadow:0 16px 36px rgba(243,115,53,0.32);}
    .card{
      background:rgba(255,255,255,0.03);
      border:1px solid var(--border);
      border-left:6px solid var(--accent2);
      border-radius:14px;
      padding:12px;
      margin-top:12px;
    }
    .warn{background:rgba(247,183,51,0.08);border-left-color:#f59e0b;}
    .mutlak{background:rgba(255,255,255,0.02);border-left-color:#111827;}
    .good{border-left-color:#16a34a;}
    .low{border-left-color:#17a2b8;}
    .mid{border-left-color:#28a745;}
    .high{border-left-color:#dc3545;}
    .muted{font-size:12px;color:var(--muted);margin-top:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px;background:rgba(255,255,255,0.02);border-radius:10px;overflow:hidden}
    th,td{border-bottom:1px solid var(--border);padding:8px;font-size:14px;text-align:left;color:var(--text)}
    th{color:var(--muted);font-weight:700;}
    .charts{display:grid;grid-template-columns:1fr;gap:16px;margin-top:18px}
    @media (min-width: 980px){
      .charts{grid-template-columns:1fr 1fr}
      .charts .fullchart{grid-column:1/-1}
    }
    .chartCard{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      box-shadow:0 12px 28px rgba(0,0,0,0.25);
    }
    .chartTitle{font-weight:800;margin-bottom:8px;color:var(--text)}
    canvas{width:100%;height:320px;display:block;border-radius:12px;background:#0f172a}
    .legend{font-size:12px;color:var(--muted);margin-top:8px;display:flex;gap:10px;flex-wrap:wrap}
    .tag{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;background:rgba(255,255,255,0.05);border:1px solid var(--border)}
    .dot{width:10px;height:10px;border-radius:50%;}
    .checkRow{display:flex;align-items:center;gap:10px;margin-top:10px}
    .extraWrap{margin-top:10px}
    .extraGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    .extraTitle{font-weight:900;margin-bottom:6px}
    @media(max-width:680px){.row{grid-template-columns:1fr;}}
  </style>
</head>
<body>
<div class="shell">
  <nav class="nav">
    <a href="index.html">Ana Sayfa</a>
    <a class="active" href="harf_notu_otomatik_grafikli.html">Harf Notu + Grafik</a>
    <a href="heatmap.html">Heatmap</a>
    <a href="detaylifinal.html">Hedef Final</a>
    <a href="anogano.html">AGNO / GANO</a>
    <a href="hakkinda.html">Hakkında</a>
  </nav>

<div class="container">
  <div class="bar">
    <div>
      <h2>Akdeniz Üniversitesi • Harf Notu (Ek Kalem + Grafik)</h2>
      <div class="muted" id="uniNote"></div>
    </div>
  </div>

  <div class="row">
    <div>
      <label>Vize Notun</label>
      <input id="inpMyMid" type="number" min="0" max="100" placeholder="0-100">
    </div>
    <div>
      <label>Final Notun</label>
      <input id="inpMyFinal" type="number" min="0" max="100" placeholder="0-100">
      <div class="muted" id="finalBarajNote">Final alt sınır (YSSL): <b>35</b> (35 altı otomatik FF)</div>
    </div>

    <div>
      <label>Sınıf Vize Ortalaması</label>
      <input id="inpClsMid" type="number" min="0" max="100" placeholder="0-100">
    </div>
    <div>
      <label>Sınıf Final Ortalaması</label>
      <input id="inpClsFinal" type="number" min="0" max="100" placeholder="0-100">
    </div>

    <div>
      <label>Vize Ağırlığı (%)</label>
      <input id="inpWMid" type="number" min="0" max="100" value="40">
    </div>
    <div>
      <label>Final Ağırlığı (%)</label>
      <input id="inpWFinal" type="number" min="0" max="100" value="60">
      <div class="muted">Ek kalem varsa toplam ağırlık yine 100 olmalı.</div>
    </div>

    <div class="full">
      <div class="checkRow">
        <input id="chkExtra" type="checkbox" style="width:auto;transform:scale(1.1)">
        <label for="chkExtra" style="margin:0;font-weight:900">Ek değerlendirme var (ödev/quiz/proje/lab...)</label>
      </div>
    </div>

    <div id="extraArea" class="full" style="display:none">
      <label>Kaç adet ek kalem?</label>
      <select id="inpExtraCount">
        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
      </select>
      <div class="muted">Her ek kalem için: Ad, ağırlık %, senin notun, sınıf ortalaması</div>
      <div id="extraList" class="extraWrap"></div>
    </div>

    <div class="full">
      <label>Standart Sapma (σ) <span class="muted">(opsiyonel)</span></label>
      <input id="inpSigma" type="number" min="0.1" step="0.1" placeholder="bilmiyorsan boş bırak → σ 5.0–25.0 (0.1 adım) simülasyon">
    </div>

    <div class="full">
      <button id="btnCalc" type="button" onclick="hesapla()">Hesapla + Grafik Çiz</button>
    </div>
  </div>

  <div id="out"></div>

  <div id="chartArea" class="charts" style="display:none;">
    <div class="chartCard">
      <div class="chartTitle">Final notu vs Harf notu</div>
      <canvas id="cvFinalVsLetter"></canvas>
      <div class="legend" id="legendFinalVs"></div>
      <div class="muted">Ek kalemler sabit kabul edilip final 0-100 taranır (YSSL=35 altı FF).</div>
    </div>

    <div class="chartCard">
      <div class="chartTitle">σ değişince harf nasıl değişiyor?</div>
      <canvas id="cvSigmaVsLetter"></canvas>
      <div class="muted">Final sabit: girdiğin final. σ 5.0–25.0 aralığında (0.1 adım) simüle edilir.</div>
    </div>

    <div class="chartCard fullchart">
      <div class="chartTitle">X-T grafiği (Akdeniz T formülü)</div>
      <canvas id="cvZT"></canvas>
      <div class="muted">Seçilen σ ile senin noktan (X,T) işaretlenir. σ boşsa 15 ile gösterilir.</div>
    </div>
  </div>
</div>


<script>
/*
  FRONTEND: Bu dosya, yüklediğin harf_notu_otomatik_grafikli.html'in HTML/CSS yapısını ve görünümünü
  değiştirmeden; sadece hesaplama (JS) tarafını Akdeniz Üniversitesi bağıl/mutlak değerlendirme kurallarına uyarlamak için güncellendi.

  Not: Yönergede BDS seçildiyse DKL üstü öğrenci sayısına (N) göre (N≤15 → MDS, N>15 → BDS) kuralı var.
  Bu sayfada frontend birebir korunması istendiği için N için ayrı input eklenmedi.
  Varsayılan olarak N=30 kabul edilir. İstersen aşağıdaki ASSUMED_N değerini dersine göre değiştirebilirsin.
*/

const ASSUMED_N = 30;  // DKL üstü öğrenci sayısı (varsayılan)
const YSSL = 35;       // Final/Büt alt sınır
const BNL  = 35;       // Başarı notu alt sınır
const SIGMA_DEFAULTS = [5, 15, 25]; // grafik legend için

function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
function round2(x){ return Math.round((x + Number.EPSILON) * 100) / 100; }
function roundInt(x){ return Math.round(x); }

const KATSAYI = { AA:4.00, BA:3.50, BB:3.00, CB:2.50, CC:2.00, DC:1.50, DD:1.00, FD:0.50, FF:0.00 };
function katsayiOf(h){ return KATSAYI[h] ?? 0; }

const LETTERS = ["AA","BA","BB","CB","CC","DC","DD","FD","FF"];
function letterIndex(L){ return LETTERS.indexOf(L); }

/* ---------- MDS (Mutlak Değerlendirme) ---------- */
function mdsFromScore(x){
  if (x >= 88) return {harf:"AA", katsayi:4.00, derece:"Başarılı"};
  if (x >= 81) return {harf:"BA", katsayi:3.50, derece:"Başarılı"};
  if (x >= 74) return {harf:"BB", katsayi:3.00, derece:"Başarılı"};
  if (x >= 67) return {harf:"CB", katsayi:2.50, derece:"Başarılı"};
  if (x >= 60) return {harf:"CC", katsayi:2.00, derece:"Başarılı"};
  if (x >= 53) return {harf:"DC", katsayi:1.50, derece:"Koşullu Başarılı"};
  if (x >= 46) return {harf:"DD", katsayi:1.00, derece:"Koşullu Başarılı"};
  if (x >= 35) return {harf:"FD", katsayi:0.50, derece:"Başarısız"};
  return {harf:"FF", katsayi:0.00, derece:"Başarısız"};
}

/* ---------- BDS: Sınıf ortalamasına göre T alt sınırlar ---------- */
function bdsThresholdsByAvg(avg){
  if (avg > 55 && avg < 60)  return {FD:41, DD:46, DC:51, CC:56, CB:61, BB:66, BA:71, AA:76};
  if (avg > 50 && avg <= 55) return {FD:43, DD:48, DC:53, CC:58, CB:63, BB:68, BA:73, AA:78};
  if (avg > 45 && avg <= 50) return {FD:45, DD:50, DC:55, CC:60, CB:65, BB:70, BA:75, AA:80};
  if (avg > 40 && avg <= 45) return {FD:47, DD:52, DC:57, CC:62, CB:67, BB:72, BA:77, AA:82};
  if (avg > 35 && avg <= 40) return {FD:49, DD:54, DC:59, CC:64, CB:69, BB:74, BA:79, AA:84};
  if (avg <= 35)             return {FD:51, DD:56, DC:61, CC:66, CB:71, BB:76, BA:81, AA:86};
  return null; // avg >= 60 -> yönerge gereği MDS
}
function bdsLetter(avg, t){
  const thr = bdsThresholdsByAvg(avg);
  if(!thr) return null;
  if (t >= thr.AA) return "AA";
  if (t >= thr.BA) return "BA";
  if (t >= thr.BB) return "BB";
  if (t >= thr.CB) return "CB";
  if (t >= thr.CC) return "CC";
  if (t >= thr.DC) return "DC";
  if (t >= thr.DD) return "DD";
  if (t >= thr.FD) return "FD";
  return "FF";
}

/* ---------- Akdeniz T hesabı ---------- */
function computeT({X, Xbar, s, N}){
  const delta = round2(X - Xbar);
  let Tbase;
  if (s < 10){
    Tbase = (60 + delta) * Math.pow((s/10), (-0.01 * delta));
  } else {
    Tbase = (0.5*s + 5) * (delta / s) + 60;
  }
  Tbase = round2(Tbase);
  const Sx = round2(s / Math.sqrt(N));
  const T = round2(Tbase + Sx);
  return {delta, Tbase, Sx, T};
}

/* ---------- Sistem seçimi (Akdeniz) ---------- */
function decideSystem({classAvg, sigma, N}){
  // sigma = 0 → MDS
  if (sigma === 0) return {mode:"MDS", reasons:["σ=0 → MDS"]};

  // classAvg < 40 → BDS (N kuralı sağlanıyorsa)
  if (classAvg < 40){
    if (N <= 15) return {mode:"MDS", reasons:["X̄<40 → BDS seçilir", "Ama N≤15 → MDS uygulanır"]};
    return {mode:"BDS", reasons:["X̄<40 → BDS (N>15 varsayımı)"]};
  }

  // classAvg >= 60 → MDS
  if (classAvg >= 60) return {mode:"MDS", reasons:["X̄≥60 → MDS"]};

  // 40 ≤ classAvg < 60 → öğretim elemanı önceden belirler; input olmadığı için iki senaryo gösterilir
  if (N <= 15) return {mode:"MDS", reasons:["40≤X̄<60 → yöntem önceden belirlenir", "Ama N≤15 ise BDS seçilse bile MDS uygulanır"]};
  return {mode:"BOTH", reasons:["40≤X̄<60 → yöntem öğretim elemanı tarafından önceden belirlenir (burada iki senaryo gösterilir)", "N>15 varsayımı"]};
}

/* ---------- UI refs (aynı) ---------- */
const chkExtra = document.getElementById("chkExtra");
const extraArea = document.getElementById("extraArea");
const inpExtraCount = document.getElementById("inpExtraCount");
const extraList = document.getElementById("extraList");
const uniNote = document.getElementById("uniNote");
const btnCalc = document.getElementById("btnCalc");
const finalBarajNote = document.getElementById("finalBarajNote");

function applyAkdenizUI(){
  uniNote.textContent = `Akdeniz Üniversitesi (BDS/MDS): YSSL=${YSSL}, BNL=${BNL}. X̄<40 → BDS, X̄≥60 → MDS, 40≤X̄<60 → yöntem önceden belirlenir. (Bu sayfada N varsayılan: ${ASSUMED_N})`;
  finalBarajNote.innerHTML = `Final alt sınır (YSSL): <b>${YSSL}</b> (Final < ${YSSL} → otomatik FF)`;
  btnCalc.disabled = false;
}

chkExtra.addEventListener("change", ()=>{
  extraArea.style.display = chkExtra.checked ? "block" : "none";
  renderExtras();
});
inpExtraCount.addEventListener("change", renderExtras);

function renderExtras(){
  extraList.innerHTML = "";
  if(!chkExtra.checked) return;
  const n = Number(inpExtraCount.value);
  for(let i=1;i<=n;i++){
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="extraTitle">Ek Kalem ${i}</div>
      <div class="extraGrid">
        <div>
          <label>Ad (opsiyonel)</label>
          <input id="exName${i}" placeholder="örn: Ödev">
        </div>
        <div>
          <label>Ağırlık (%)</label>
          <input id="exW${i}" type="number" min="0" max="100" placeholder="örn: 10">
        </div>
        <div>
          <label>Senin Notun</label>
          <input id="exMy${i}" type="number" min="0" max="100" placeholder="0-100">
        </div>
        <div>
          <label>Sınıf Ortalaması</label>
          <input id="exCls${i}" type="number" min="0" max="100" placeholder="0-100">
        </div>
      </div>
    `;
    extraList.appendChild(div);
  }
}

/* ---------- Data (aynı input seti) ---------- */
function collectData(){
  return {
    myMid: Number(document.getElementById("inpMyMid").value),
    myFinal: Number(document.getElementById("inpMyFinal").value),
    clsMid: Number(document.getElementById("inpClsMid").value),
    clsFinal: Number(document.getElementById("inpClsFinal").value),
    wMidPct: Number(document.getElementById("inpWMid").value),
    wFinalPct: Number(document.getElementById("inpWFinal").value),
    sigmaStr: document.getElementById("inpSigma").value.trim(),
    extras: readExtras()
  };
}

function readExtras(){
  if(!chkExtra.checked) return [];
  const n = Number(inpExtraCount.value);
  const arr = [];
  for(let i=1;i<=n;i++){
    arr.push({
      name: (document.getElementById(`exName${i}`).value || `Ek ${i}`).trim(),
      wPct: Number(document.getElementById(`exW${i}`).value),
      my: Number(document.getElementById(`exMy${i}`).value),
      cls: Number(document.getElementById(`exCls${i}`).value)
    });
  }
  return arr;
}

function validateData(d){
  const nums = [d.myMid, d.myFinal, d.clsMid, d.clsFinal];
  if(nums.some(v => !Number.isFinite(v) || v<0 || v>100)) return "Tüm notlar 0-100 arasında olmalı.";
  if(!Number.isFinite(d.wMidPct)||!Number.isFinite(d.wFinalPct)||d.wMidPct<0||d.wFinalPct<0) return "Ağırlıkları düzgün gir.";

  const sigmaStr = d.sigmaStr;
  if(sigmaStr){
    const s = Number(sigmaStr);
    if(!Number.isFinite(s) || s<0 || s>50) return "σ (standart sapma) 0-50 arasında olmalı (ya da boş bırak).";
  }

  let total = d.wMidPct + d.wFinalPct;
  for(const ex of d.extras){
    if(!Number.isFinite(ex.wPct)||ex.wPct<0||ex.wPct>100) return `${ex.name}: ağırlık 0-100 olmalı.`;
    if(!Number.isFinite(ex.my)||ex.my<0||ex.my>100) return `${ex.name}: senin notun 0-100 olmalı.`;
    if(!Number.isFinite(ex.cls)||ex.cls<0||ex.cls>100) return `${ex.name}: sınıf ortalaması 0-100 olmalı.`;
    total += ex.wPct;
  }
  if(Math.round(total*100)/100 !== 100) return `Ağırlıkların toplamı 100 olmalı. Şu an: ${total}`;
  return null;
}

/* ---------- Totals ---------- */
function computeTotals(d){
  const wMid = d.wMidPct/100;
  const wFinal = d.wFinalPct/100;
  const extrasN = d.extras.map(ex => ({...ex, w: ex.wPct/100}));

  const ogrRaw =
    d.myMid*wMid +
    d.myFinal*wFinal +
    extrasN.reduce((a,x)=>a + x.my*x.w, 0);

  const clsRaw =
    d.clsMid*wMid +
    d.clsFinal*wFinal +
    extrasN.reduce((a,x)=>a + x.cls*x.w, 0);

  const X = roundInt(ogrRaw);
  const Xbar = round2(clsRaw);

  return {ogrRaw, clsRaw, X, Xbar, wMid, wFinal, extrasN};
}

/* ---------- Chart helpers (aynı) ---------- */
function setupCanvas(canvas){
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = rect.width * dpr;
  canvas.height = rect.height * dpr;
  ctx.scale(dpr,dpr);
  return ctx;
}
function clear(ctx, W, H){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle="#0f172a";
  ctx.fillRect(0,0,W,H);
}
function drawAxes(ctx, plot, xlabel, ylabel){
  ctx.strokeStyle="#1f2937"; ctx.lineWidth=1.2;
  ctx.beginPath(); ctx.moveTo(plot.x0, plot.y1); ctx.lineTo(plot.x1, plot.y1); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(plot.x0, plot.y0); ctx.lineTo(plot.x0, plot.y1); ctx.stroke();
  ctx.fillStyle="#cdd7ea"; ctx.font="12px Arial"; ctx.fillText(xlabel, plot.x1-10, plot.y1+22);
  ctx.save(); ctx.translate(plot.x0-26, plot.y0+12); ctx.rotate(-Math.PI/2); ctx.fillText(ylabel, 0,0); ctx.restore();
}
function drawLine(ctx, pts, color, width){
  ctx.strokeStyle=color; ctx.lineWidth=width;
  ctx.beginPath();
  pts.forEach((p,i)=> i===0 ? ctx.moveTo(p.x,p.y) : ctx.lineTo(p.x,p.y));
  ctx.stroke();
}
function drawPoints(ctx, pts, color, size){
  ctx.fillStyle=color;
  pts.forEach(p=>{
    ctx.beginPath();
    ctx.arc(p.x,p.y,size,0,Math.PI*2);
    ctx.fill();
  });
}
function drawXGrid(ctx, plot, xs){
  ctx.strokeStyle="#1f2937";
  xs.forEach(x=>{
    ctx.beginPath(); ctx.moveTo(x, plot.y0); ctx.lineTo(x, plot.y1); ctx.stroke();
  });
}
function xScale(v, vmin, vmax, plot){
  return plot.x0 + (v - vmin) * (plot.x1 - plot.x0) / (vmax - vmin);
}
function yScale(v, vmin, vmax, plot){
  return plot.y1 - (v - vmin) * (plot.y1 - plot.y0) / (vmax - vmin);
}

/* ---------- Letter resolver for charts (Akdeniz + e-kuralı) ---------- */
function finalLetterAkdeniz({dBase, myFinalOverride, sigma, N, prefer}){
  const d = {...dBase, myFinal: (myFinalOverride ?? dBase.myFinal), sigmaStr: sigma!=null ? String(sigma) : dBase.sigmaStr};
  const totals = computeTotals(d);
  const X = totals.X;

  // YSSL/BNL
  if ((myFinalOverride ?? dBase.myFinal) < YSSL || X < BNL) return "FF";

  const mds = mdsFromScore(X);

  // sigma yoksa BDS çizimi için MDS döndür
  if (!Number.isFinite(sigma) || sigma <= 0) return mds.harf;

  const sys = decideSystem({classAvg: totals.Xbar, sigma, N});
  if (sys.mode === "MDS") return mds.harf;

  if (sys.mode === "BOTH" && prefer === "MDS") return mds.harf;

  // BDS hesap
  const tcalc = computeT({X, Xbar: totals.Xbar, s: sigma, N});
  const hB = bdsLetter(totals.Xbar, tcalc.T) || "FF";
  const bK = katsayiOf(hB);
  // e-kuralı
  return (bK < mds.katsayi) ? mds.harf : hB;
}

/* ---------- Charts ---------- */
function drawFinalVsLetterWithExtras_Akdeniz({d, sigmaStr}){
  const canvas = document.getElementById("cvFinalVsLetter");
  const ctx = setupCanvas(canvas);
  const W = canvas.getBoundingClientRect().width;
  const H = canvas.getBoundingClientRect().height;
  clear(ctx, W, H);

  const plot = {x0:46, y0:18, x1:W-10, y1:H-40};
  drawAxes(ctx, plot, "Final", "Harf");

  const xmin=0, xmax=100;
  const xt=[0,20,35,50,70,100];
  drawXGrid(ctx, plot, xt.map(v=>xScale(v,xmin,xmax,plot)));
  ctx.fillStyle="#cdd7ea"; ctx.font="12px Arial";
  xt.forEach(v=>ctx.fillText(String(v), xScale(v,xmin,xmax,plot)-8, plot.y1+18));

  const sigmas = sigmaStr ? [Number(sigmaStr)] : SIGMA_DEFAULTS;
  const colors = ["#16a34a","#f59e0b","#ef4444"];

  sigmas.forEach((s,idx)=>{
    const pts=[];
    for(let f=xmin; f<=xmax; f+=0.5){
      const L = finalLetterAkdeniz({dBase:d, myFinalOverride:f, sigma:s, N:ASSUMED_N, prefer:"BDS"});
      const x = xScale(f,xmin,xmax,plot);
      const y = plot.y1 - (letterIndex(L) * (plot.y1-plot.y0)/(LETTERS.length-1));
      pts.push({x,y});
    }
    drawLine(ctx, pts, colors[idx%colors.length], 2);
  });

  const legend = document.getElementById("legendFinalVs");
  legend.innerHTML = sigmas.map((s,i)=>`<span class="tag"><span class="dot" style="background:${colors[i%colors.length]}"></span>σ=${s}</span>`).join("");
}

function drawSigmaVsLetterWithExtras_Akdeniz({d}){
  const canvas = document.getElementById("cvSigmaVsLetter");
  const ctx = setupCanvas(canvas);
  const W = canvas.getBoundingClientRect().width;
  const H = canvas.getBoundingClientRect().height;
  clear(ctx, W, H);

  const plot = {x0:46, y0:18, x1:W-10, y1:H-40};
  drawAxes(ctx, plot, "σ (Standart Sapma)", "Harf");

  const xmin=5, xmax=25;
  const xt=[5,10,15,20,25];
  drawXGrid(ctx, plot, xt.map(v=>xScale(v,xmin,xmax,plot)));
  ctx.fillStyle="#cdd7ea"; ctx.font="12px Arial";
  xt.forEach(v=>ctx.fillText(String(v), xScale(v,xmin,xmax,plot)-6, plot.y1+18));

  const totals = computeTotals(d);

  // Sistem MDS ise (X̄≥60) σ etkisiz: sabit çizgi
  if(totals.Xbar >= 60){
    const L = mdsFromScore(totals.X).harf;
    const y = plot.y1 - (letterIndex(L) * (plot.y1-plot.y0)/(LETTERS.length-1));
    ctx.strokeStyle="#111827"; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(plot.x0,y); ctx.lineTo(plot.x1,y); ctx.stroke();
    ctx.fillStyle="#cdd7ea";
    ctx.fillText("X̄≥60 → MDS (σ etkisiz)", plot.x0+8, plot.y0+14);
    return;
  }

  const sigmas=[];
  for(let s=xmin; s<=xmax+1e-9; s+=0.1) sigmas.push(Math.round(s*10)/10);

  const pts = sigmas.map(s=>{
    const L = finalLetterAkdeniz({dBase:d, sigma:s, N:ASSUMED_N, prefer:"BDS"});
    return {
      x: xScale(s,xmin,xmax,plot),
      y: plot.y1 - (letterIndex(L) * (plot.y1-plot.y0)/(LETTERS.length-1))
    };
  });

  drawLine(ctx, pts, "#111827", 2);

  [5,15,25].forEach(s=>{
    const L = finalLetterAkdeniz({dBase:d, sigma:s, N:ASSUMED_N, prefer:"BDS"});
    const x = xScale(s,xmin,xmax,plot);
    const y = plot.y1 - (letterIndex(L) * (plot.y1-plot.y0)/(LETTERS.length-1));
    drawPoints(ctx, [{x,y}], "#dc2626", 3);
    ctx.fillStyle="#cdd7ea"; ctx.font="12px Arial";
    ctx.fillText(`σ=${s}`, x+6, y-6);
    ctx.fillText(L, x+6, y+10);
  });

  if(totals.Xbar >= 40 && totals.Xbar < 60){
    ctx.fillStyle="#cdd7ea"; ctx.font="12px Arial";
    ctx.fillText("Not: 40≤X̄<60 → yöntemi öğretim elemanı belirler (grafikte BDS varsayıldı).", plot.x0+8, plot.y0+14);
  }
}

function drawXTWithExtras_Akdeniz({d, sigmaForPoint}){
  const canvas = document.getElementById("cvZT"); // id aynı kalsın
  const ctx = setupCanvas(canvas);
  const W = canvas.getBoundingClientRect().width;
  const H = canvas.getBoundingClientRect().height;
  clear(ctx, W, H);

  const plot = {x0:52, y0:16, x1:W-16, y1:H-44};
  drawAxes(ctx, plot, "X (Başarı Notu)", "T");

  const totals = computeTotals(d);
  const Xbar = totals.Xbar;

  if(!Number.isFinite(sigmaForPoint) || sigmaForPoint<=0){
    ctx.fillStyle="#cdd7ea";
    ctx.fillText("σ girilmedi → T grafiği için σ gerekir (BDS).", plot.x0+10, plot.y0+16);
    return;
  }

  const xmin=0, xmax=100, tmin=20, tmax=110;
  const xticks=[0,20,35,50,70,100];
  const tticks=[20,40,60,80,100,110];

  ctx.font="12px Arial"; ctx.fillStyle="#cdd7ea";
  xticks.forEach(xv=>{
    const x=xScale(xv,xmin,xmax,plot);
    ctx.strokeStyle="#1f2937";
    ctx.beginPath(); ctx.moveTo(x,plot.y0); ctx.lineTo(x,plot.y1); ctx.stroke();
    ctx.fillText(String(xv), x-6, plot.y1+18);
  });
  tticks.forEach(tv=>{
    const y=yScale(tv,tmin,tmax,plot);
    ctx.strokeStyle="#1f2937";
    ctx.beginPath(); ctx.moveTo(plot.x0,y); ctx.lineTo(plot.x1,y); ctx.stroke();
    ctx.fillText(String(tv), plot.x0-34, y+4);
  });

  const line=[];
  for(let X=0; X<=100; X+=1){
    const t = computeT({X, Xbar, s:sigmaForPoint, N:ASSUMED_N}).T;
    line.push({x:xScale(X,xmin,xmax,plot), y:yScale(clamp(t,tmin,tmax),tmin,tmax,plot)});
  }
  drawLine(ctx, line, "#111827", 2);

  const Xme = totals.X;
  const tMe = computeT({X:Xme, Xbar, s:sigmaForPoint, N:ASSUMED_N}).T;
  const px = xScale(clamp(Xme,xmin,xmax), xmin,xmax,plot);
  const py = yScale(clamp(tMe,tmin,tmax), tmin,tmax,plot);
  drawPoints(ctx, [{x:px,y:py}], "#dc2626", 4);
  ctx.fillStyle="#dc2626";
  ctx.fillText(`(X=${Xme}, T=${tMe.toFixed(2)})`, px+8, py-8);
}

/* ---------- Main ---------- */
function hesapla(){
  const out = document.getElementById("out");
  out.innerHTML = "";

  const d = collectData();
  const err = validateData(d);
  if(err){
    out.innerHTML = `<div class="card warn">Uyarı: ${err}</div>`;
    document.getElementById("chartArea").style.display="none";
    return;
  }

  const totals = computeTotals(d);
  const X = totals.X;
  const Xbar = totals.Xbar;

  // YSSL / BNL kuralı
  if(d.myFinal < YSSL || X < BNL){
    out.innerHTML = `<div class="card warn"><b>SONUÇ: FF</b><br>
      ${d.myFinal < YSSL ? `Final < ${YSSL} (YSSL) → otomatik FF.<br>` : ""}
      ${X < BNL ? `Başarı notu X < ${BNL} (BNL) → otomatik FF.<br>` : ""}
      <div class="muted">Not: X = ağırlıklı başarı notu (tamsayıya yuvarlanır). Varsayılan N=${ASSUMED_N}.</div>
    </div>`;
    document.getElementById("chartArea").style.display="none";
    return;
  }

  const sigmaStr = d.sigmaStr;
  const sigma = sigmaStr ? Number(sigmaStr) : null;

  // Bilgi kartı
  let html = `
    <div class="card">
      <b>Başarı Notu (X):</b> ${X} <span class="muted">(ham: ${totals.ogrRaw.toFixed(2)})</span><br>
      <b>Sınıf Ortalaması (X̄):</b> ${Xbar.toFixed(2)} <span class="muted">(ham: ${totals.clsRaw.toFixed(2)})</span><br>
      <div class="muted">Ek kalemler dahil ağırlıklı hesaplandı. Varsayılan N=${ASSUMED_N}.</div>
    </div>
  `;

  // Kalem tablosu (aynı)
  let t = `
    <table>
      <thead><tr><th>Kalem</th><th>Ağırlık</th><th>Sen</th><th>Sınıf Ort</th><th>Sen Katkın</th><th>Sınıf Katkısı</th></tr></thead>
      <tbody>
        <tr><td><b>Vize</b></td><td>${d.wMidPct}%</td><td>${d.myMid}</td><td>${d.clsMid}</td><td>${(d.myMid*totals.wMid).toFixed(2)}</td><td>${(d.clsMid*totals.wMid).toFixed(2)}</td></tr>
        <tr><td><b>Final</b></td><td>${d.wFinalPct}%</td><td>${d.myFinal}</td><td>${d.clsFinal}</td><td>${(d.myFinal*totals.wFinal).toFixed(2)}</td><td>${(d.clsFinal*totals.wFinal).toFixed(2)}</td></tr>
  `;
  totals.extrasN.forEach(ex=>{
    t += `<tr><td><b>${ex.name}</b></td><td>${ex.wPct}%</td><td>${ex.my}</td><td>${ex.cls}</td><td>${(ex.my*ex.w).toFixed(2)}</td><td>${(ex.cls*ex.w).toFixed(2)}</td></tr>`;
  });
  t += `</tbody></table>`;
  html += `<div class="card">${t}</div>`;

  // MDS referans
  const mds = mdsFromScore(X);

  // Sistem kararı
  const sys = decideSystem({classAvg:Xbar, sigma, N:ASSUMED_N});
  html += `<div class="card mutlak"><b>Sistem kararı:</b><br>${sys.reasons.map(r=>`• ${r}`).join("<br>")}</div>`;

  function resCard(title, obj, extraHtml=""){
    const cls = obj.harf==="FF" ? "warn" : "good";
    return `<div class="card ${cls}"><b>${title}</b><br>Harf: <b>${obj.harf}</b> • Katsayı: ${obj.katsayi.toFixed(2)}${extraHtml}</div>`;
  }

  if(sys.mode === "MDS"){
    html += resCard("Nihai sonuç (MDS)", mds);
  }

  if(sys.mode === "BDS"){
    if(!sigmaStr){
      html += `<div class="card warn"><b>BDS gerekli</b> ama σ bilinmediği için tek harf hesaplanamaz. Aşağıda σ 5.0–25.0 aralığı (0.1 adım) ile olası harf dağılımı verildi. (e-kuralı uygulanır.)</div>`;
      html += resCard("MDS (referans)", mds);

      const counts={}, sMin=5.0, sMax=25.0, step=0.1;
      let n=0;
      for(let s=sMin; s<=sMax+1e-9; s+=step){
        const ss = Math.round(s*10)/10;
        const tcalc = computeT({X, Xbar, s:ss, N:ASSUMED_N});
        const hB = bdsLetter(Xbar, tcalc.T) || "FF";
        const finalH = (katsayiOf(hB) < mds.katsayi) ? mds.harf : hB;
        counts[finalH] = (counts[finalH]||0)+1;
        n++;
      }
      const letters = LETTERS.filter(L=>counts[L]);
      html += `<div class="card">
        <b>Harf notu olasılığı (σ bilinmiyor)</b>
        <div class="muted">σ 5.0–25.0 aralığında 0.1 adım ile tarandı (tüm σ değerleri eşit ağırlıklı). e-kuralı (BDS daha düşükse MDS) uygulanmıştır.</div>
        <table>
          <thead><tr><th>Harf</th><th>Olasılık</th></tr></thead>
          <tbody>
            ${letters.map(L=>`<tr><td><b>${L}</b></td><td>${((counts[L]/n)*100).toFixed(1)}%</td></tr>`).join("")}
          </tbody>
        </table>
      </div>`;
    } else {
      const tcalc = computeT({X, Xbar, s:sigma, N:ASSUMED_N});
      const hB = bdsLetter(Xbar, tcalc.T) || "FF";
      const bds = {harf:hB, katsayi:katsayiOf(hB)};
      const eOverride = bds.katsayi < mds.katsayi;

      html += resCard("BDS hesap", bds, `<br><span class="muted">T=${tcalc.T.toFixed(2)} = Tbase ${tcalc.Tbase.toFixed(2)} + Sx ${tcalc.Sx.toFixed(2)} (N=${ASSUMED_N})</span>`);
      html += resCard("MDS (referans)", mds);

      if(eOverride){
        html += `<div class="card warn"><b>e-kuralı:</b> BDS katsayısı MDS’den düşük → <b>MDS uygulanır</b>.</div>`;
        html += resCard("Nihai sonuç", mds);
      } else {
        html += resCard("Nihai sonuç", bds);
      }
    }
  }

  if(sys.mode === "BOTH"){
    html += `<div class="card warn"><b>40 ≤ X̄ &lt; 60</b> aralığı: yöntem öğretim elemanı tarafından önceden belirlenir. Aşağıda hem MDS hem BDS senaryosu gösterildi. (BDS için σ gerekir.)</div>`;
    html += resCard("MDS senaryosu", mds);

    if(!sigmaStr){
      const counts={}, sMin=5.0, sMax=25.0, step=0.1;
      let n=0;
      for(let s=sMin; s<=sMax+1e-9; s+=step){
        const ss = Math.round(s*10)/10;
        const tcalc = computeT({X, Xbar, s:ss, N:ASSUMED_N});
        const hB = bdsLetter(Xbar, tcalc.T) || "FF";
        const finalH = (katsayiOf(hB) < mds.katsayi) ? mds.harf : hB;
        counts[finalH] = (counts[finalH]||0)+1;
        n++;
      }
      const letters = LETTERS.filter(L=>counts[L]);
      html += `<div class="card">
        <b>BDS olasılığı (σ bilinmiyor)</b>
        <div class="muted">σ 5.0–25.0 aralığında 0.1 adım ile tarandı. e-kuralı uygulanmıştır.</div>
        <table>
          <thead><tr><th>Harf</th><th>Olasılık</th></tr></thead>
          <tbody>
            ${letters.map(L=>`<tr><td><b>${L}</b></td><td>${((counts[L]/n)*100).toFixed(1)}%</td></tr>`).join("")}
          </tbody>
        </table>
      </div>`;
    } else {
      const tcalc = computeT({X, Xbar, s:sigma, N:ASSUMED_N});
      const hB = bdsLetter(Xbar, tcalc.T) || "FF";
      const bds = {harf:hB, katsayi:katsayiOf(hB)};
      const eOverride = bds.katsayi < mds.katsayi;
      html += resCard("BDS senaryosu", bds, `<br><span class="muted">T=${tcalc.T.toFixed(2)} = Tbase ${tcalc.Tbase.toFixed(2)} + Sx ${tcalc.Sx.toFixed(2)} (N=${ASSUMED_N})</span>`);
      if(eOverride){
        html += `<div class="card warn"><b>Not:</b> BDS bu σ ile MDS’den düşük → e-kuralı gereği MDS’ye döner.</div>`;
      }
    }
  }

  out.innerHTML = html;

  // Charts
  document.getElementById("chartArea").style.display="grid";
  drawFinalVsLetterWithExtras_Akdeniz({d, sigmaStr});
  drawSigmaVsLetterWithExtras_Akdeniz({d});
  const sigmaForPoint = sigmaStr ? Number(sigmaStr) : 15;
  drawXTWithExtras_Akdeniz({d, sigmaForPoint});
}

/* ---------- Init ---------- */
function init(){
  applyAkdenizUI();
  renderExtras();
}

window.addEventListener("resize", ()=>{
  const chartArea = document.getElementById("chartArea");
  if(chartArea.style.display !== "none"){
    try{ hesapla(); }catch(e){}
  }
});

init();
</script>

</div>
</body>
</html>
