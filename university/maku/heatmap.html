<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mehmet Akif Ersoy Üniversitesi • Final–S Heatmap (MAKÜ Bağıl Değerlendirme)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Manrope:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b132b;
      --bg2:#0f162f;
      --card:#0f172a;
      --glass:rgba(255,255,255,0.05);
      --accent:#f7b733;
      --accent2:#21e6c1;
      --text:#e8eefb;
      --muted:#9fb1d1;
      --border:#1f2a44;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Space Grotesk","Manrope",system-ui,-apple-system,sans-serif;
      min-height:100vh;
      background:radial-gradient(circle at 20% 18%, rgba(33,230,193,0.16), transparent 32%),
                 radial-gradient(circle at 82% 8%, rgba(247,183,51,0.16), transparent 32%),
                 linear-gradient(145deg, var(--bg), var(--bg2));
      color:var(--text);
    }
    .shell{max-width:1100px;margin:0 auto;padding:26px 18px 34px;}
    nav.nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px}
    nav.nav a{
      color:var(--text);text-decoration:none;padding:10px 14px;
      border:1px solid var(--border);border-radius:12px;
      background:rgba(255,255,255,0.05);font-weight:800;
      transition:background .15s ease,border-color .15s ease,color .15s ease;
    }
    nav.nav a.active{border-color:var(--accent);color:var(--accent);background:rgba(247,183,51,0.12);}
    .panel{
      background:var(--glass);
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow:0 18px 50px rgba(0,0,0,0.28);
      margin-bottom:14px;
    }
    h1{margin:0 0 10px;font-size:26px;letter-spacing:-0.3px;}
    .lead{margin:0 0 12px;color:var(--muted);line-height:1.6;}
    label{font-weight:700;display:block;margin-top:8px;font-size:14px}
    input,select,button{
      width:100%;
      padding:11px 12px;
      margin-top:6px;
      font-size:15px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.06);
      color:var(--text);
    }
    input:focus,select:focus{
      outline:none;
      border-color:var(--accent2);
      box-shadow:0 0 0 3px rgba(33,230,193,0.2);
    }
    button{
      background:linear-gradient(120deg,var(--accent),#f37335);
      color:#0b0c10;
      border:none;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      margin-top:12px;
      box-shadow:0 12px 30px rgba(243,115,53,0.25);
      transition:transform .18s ease, box-shadow .18s ease;
    }
    button:hover{transform:translateY(-2px);box-shadow:0 16px 36px rgba(243,115,53,0.32);}
    .muted{font-size:12px;color:var(--muted);margin-top:4px}
    .card{background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px;}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .full{grid-column:1/-1}
    .checkRow{display:flex;align-items:center;gap:10px;margin-top:10px}
    .extraWrap{margin-top:10px}
    .extraGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px}
    .extraTitle{font-weight:900;margin-bottom:6px}
    .layout{display:grid;grid-template-columns:1.4fr 1fr;gap:14px;margin-top:14px}
    @media (max-width: 980px){ .layout{grid-template-columns:1fr} }
    canvas{width:100%;height:520px;display:block;border-radius:12px;background:#0f172a}
    .legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.06);font-size:12px;color:var(--text);display:inline-flex;gap:8px;align-items:center;border:1px solid var(--border)}
    .sw{width:14px;height:14px;border-radius:4px;border:1px solid rgba(0,0,0,.12)}
    .tooltip{
      position:fixed; pointer-events:none; z-index:99;
      background:#0f172a; color:#fff; padding:10px 12px; border-radius:10px;
      font-size:12px; max-width:340px; line-height:1.35; display:none;
      box-shadow:0 10px 25px rgba(0,0,0,.35); border:1px solid var(--border);
    }
    .tipTitle{font-weight:900;margin-bottom:6px}
    .gridSmall{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .topBar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .badge{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,0.05);font-weight:900;}
    .badge b{color:var(--accent)}
  </style>
</head>
<body>
  <div class="shell">
    <nav class="nav">
      <a href="index.html">Ana Sayfa</a>
      <a href="harf_notu_otomatik_grafikli.html">Harf Notu + Grafik</a>
      <a class="active" href="heatmap.html">Heatmap</a>
      <a href="detaylifinal.html">Hedef Final</a>
      <a href="anogano.html">AGNO / GANO</a>
      <a href="hakkinda.html">Hakkında</a>
    </nav>

    <div class="panel">
      <div class="topBar">
        <div>
          <h1>Mehmet Akif Ersoy Üniversitesi • Final–S Heatmap</h1>
          <p class="lead">
            Final notu (X ekseni) ve standart sapma S (Y ekseni) değiştikçe harf notunun nasıl değiştiğini gösterir.
            MAKÜ yönergesindeki kurallar uygulanır: YSSL barajı, BDKAL/BDKÜL, HBAL/HBÜL, N≥20 bağıl (T=((X−X̄)/S)×10+70),
            N&lt;20 yarı bağıl (T=(X−X̄)+70).
          </p>
        </div>
        <div style="min-width:260px">
          <label style="margin-top:0">Program</label>
          <select id="selProgram">
            <option value="" selected disabled>Seçiniz…</option>
            <option value="lisans">Lisans</option>
            <option value="onlisans">Önlisans</option>
          </select>
          <div class="muted" id="noteProgram"></div>
        </div>
      </div>

      <div id="formArea" style="display:none;">
        <div class="row">
          <div>
            <label>Vize Notun</label>
            <input id="inpMyMid" type="number" min="0" max="100" placeholder="0-100">
          </div>
          <div>
            <label>Final Notun (mevcut)</label>
            <input id="inpMyFinal" type="number" min="0" max="100" placeholder="0-100">
            <div class="muted" id="noteBaraj"></div>
          </div>

          <div>
            <label>Sınıf Vize Ortalaması</label>
            <input id="inpClsMid" type="number" min="0" max="100" placeholder="0-100">
          </div>
          <div>
            <label>Sınıf Final Ortalaması</label>
            <input id="inpClsFinal" type="number" min="0" max="100" placeholder="0-100">
          </div>

          <div>
            <label>Katılan Öğrenci Sayısı (N)</label>
            <input id="inpN" type="number" min="1" step="1" placeholder="örn: 72">
            <div class="muted">N ≥ 20 → bağıl (S kullanılır) • N &lt; 20 → yarı bağıl (S kullanılmaz)</div>
          </div>

          <div>
            <label>Vize Ağırlığı (%)</label>
            <input id="inpWMid" type="number" min="0" max="100" value="40">
          </div>
          <div>
            <label>Final Ağırlığı (%)</label>
            <input id="inpWFinal" type="number" min="0" max="100" value="60">
            <div class="muted">Vize + Final + (ek kalemler) toplamı 100 olmalı.</div>
          </div>

          <div class="full">
            <div class="checkRow">
              <input id="chkExtra" type="checkbox" style="width:auto;transform:scale(1.1)">
              <label for="chkExtra" style="margin:0;font-weight:900">Ek değerlendirme var (ödev/quiz/proje...)</label>
            </div>
          </div>

          <div id="extraArea" class="full" style="display:none">
            <label>Kaç adet ek kalem?</label>
            <select id="inpExtraCount">
              <option value="1">1</option><option value="2">2</option><option value="3">3</option>
              <option value="4">4</option><option value="5">5</option><option value="6">6</option>
            </select>
            <div class="muted">Her ek kalem için: Ad, ağırlık %, senin notun, sınıf ortalaması</div>
            <div id="extraList" class="extraWrap"></div>
          </div>

          <div class="full panel" style="margin-top:8px;">
            <div class="gridSmall">
              <div>
                <label>Final Aralığı</label>
                <div class="gridSmall">
                  <input id="inpFinalMin" type="number" min="0" max="100" value="0" placeholder="min">
                  <input id="inpFinalMax" type="number" min="0" max="100" value="100" placeholder="max">
                </div>
                <div class="muted">Heatmap final puanını bu aralıkta tarar (baraj altı otomatik FD olur).</div>
              </div>
              <div>
                <label>S Aralığı (Standart Sapma) — otomatik taranır</label>
                <div class="gridSmall">
                  <input id="inpSMin" type="number" min="0.1" max="60" value="5" placeholder="min">
                  <input id="inpSMax" type="number" min="0.1" max="60" value="30" placeholder="max">
                </div>
                <div class="muted">Bu sayfada S kullanıcıdan istenmez; Y ekseni bu aralıktır.</div>
              </div>
            </div>

            <div class="gridSmall">
              <div>
                <label>Hücre Yoğunluğu</label>
                <select id="inpRes">
                  <option value="40">Normal (40x40)</option>
                  <option value="55" selected>Detaylı (55x55)</option>
                  <option value="70">Çok detay (70x70)</option>
                </select>
                <div class="muted">Daha detay = daha ağır çizim.</div>
              </div>
              <div>
                <label>Renk seti</label>
                <select id="inpLetterSet">
                  <option value="9" selected>FF-FD-DD-DC-CC-CB-BB-BA-AA</option>
                  <option value="6">FF-FD-DC-CC-BB-AA (basit)</option>
                </select>
              </div>
            </div>

            <button type="button" onclick="drawAll()">Heatmap Çiz</button>
            <div id="status" class="muted"></div>
          </div>
        </div>

        <div class="layout">
          <div class="panel">
            <div style="font-weight:900;margin-bottom:8px;">Heatmap</div>
            <canvas id="cv"></canvas>
            <div class="legend" id="legend"></div>
            <div class="muted">X: Final — Y: Standart sapma S. Hücre rengi = harf notu.</div>
          </div>

          <div class="panel">
            <div style="font-weight:900;margin-bottom:8px;">Mevcut Durum Özeti</div>
            <div id="summary" class="muted">Henüz hesaplanmadı.</div>
            <div class="card" style="margin-top:12px;">
              <div class="badge">Eşikler: <b>BDKAL</b>=15 • <b>HBAL</b>=35 • <b>HBÜL</b>=90 • <b>BDKÜL</b>=95</div>
              <div class="muted" style="margin-top:8px;">
                Final &lt; YSSL → <b>FD</b> • X&lt;15 → <b>FF</b> • 15≤X&lt;35 → <b>FD</b> • 90≤X&lt;95 → <b>AA</b> • X≥95 → <b>AA</b>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tooltip" id="tip"></div>

<script>
function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

const THRESH = { BDKAL:15, BDKUL:95, HBAL:35, HBUL:90 };

const CONFIG = {
  lisans: {
    label: "Lisans",
    yssl: 50,
    table: [
      {name:"Mükemmel 1", xbarLow:85.00, xbarHigh:95.00, ranges:{FD:[0.00,28.99], DD:[29.00,43.49], DC:[43.50,49.99], CC:[50.00,55.49], CB:[55.50,60.49], BB:[60.50,66.64], BA:[66.65,69.99], AA:[70.00,100.00]}},
      {name:"Mükemmel 2", xbarLow:80.00, xbarHigh:84.99, ranges:{FD:[0.00,33.49], DD:[33.50,45.99], DC:[46.00,52.49], CC:[52.50,57.99], CB:[58.00,62.99], BB:[63.00,67.99], BA:[68.00,70.99], AA:[71.00,100.00]}},
      {name:"Mükemmel 3", xbarLow:75.00, xbarHigh:79.99, ranges:{FD:[0.00,37.99], DD:[38.00,48.99], DC:[49.00,54.99], CC:[55.00,60.49], CB:[60.50,65.49], BB:[65.50,70.49], BA:[70.50,72.99], AA:[73.00,100.00]}},
      {name:"Mükemmel 4", xbarLow:70.00, xbarHigh:74.99, ranges:{FD:[0.00,39.99], DD:[40.00,50.99], DC:[51.00,56.99], CC:[57.00,61.99], CB:[62.00,67.49], BB:[67.50,72.49], BA:[72.50,77.99], AA:[78.00,100.00]}},
      {name:"Çok İyi",     xbarLow:62.50, xbarHigh:69.99, ranges:{FD:[0.00,50.99], DD:[51.00,55.99], DC:[56.00,60.49], CC:[60.50,65.49], CB:[65.50,70.49], BB:[70.50,75.99], BA:[76.00,80.49], AA:[80.50,100.00]}},
      {name:"İyi",         xbarLow:57.50, xbarHigh:62.49, ranges:{FD:[0.00,52.49], DD:[52.50,57.99], DC:[58.00,62.49], CC:[62.50,67.99], CB:[68.00,72.99], BB:[73.00,77.99], BA:[78.00,82.49], AA:[82.50,100.00]}},
      {name:"Orta Üstü",   xbarLow:52.50, xbarHigh:57.49, ranges:{FD:[0.00,54.99], DD:[55.00,58.99], DC:[59.00,64.99], CC:[65.00,69.99], CB:[70.00,74.99], BB:[75.00,79.99], BA:[80.00,84.49], AA:[84.50,100.00]}},
      {name:"Orta",        xbarLow:47.50, xbarHigh:52.49, ranges:{FD:[0.00,56.99], DD:[57.00,61.99], DC:[62.00,66.99], CC:[67.00,71.99], CB:[72.00,76.99], BB:[77.00,81.49], BA:[81.50,87.49], AA:[87.50,100.00]}},
      {name:"Zayıf",       xbarLow:42.50, xbarHigh:47.49, ranges:{FD:[0.00,58.99], DD:[59.00,63.99], DC:[64.00,68.99], CC:[69.00,73.99], CB:[74.00,78.99], BB:[79.00,83.99], BA:[84.00,88.49], AA:[88.50,100.00]}},
      {name:"Kötü",        xbarLow:15.00, xbarHigh:42.49, ranges:{FD:[0.00,60.49], DD:[60.50,66.49], DC:[66.50,70.99], CC:[71.00,75.99], CB:[76.00,80.49], BB:[80.50,85.99], BA:[86.00,90.49], AA:[90.50,100.00]}},
    ]
  },
  onlisans: {
    label: "Önlisans",
    yssl: 45,
    table: [
      {name:"Mükemmel 1", xbarLow:80.00, xbarHigh:95.00, ranges:{FD:[0.00,28.99], DD:[29.00,43.49], DC:[43.50,49.99], CC:[50.00,55.49], CB:[55.50,60.49], BB:[60.50,66.64], BA:[66.65,69.99], AA:[70.00,100.00]}},
      {name:"Mükemmel 2", xbarLow:70.00, xbarHigh:79.99, ranges:{FD:[0.00,33.49], DD:[33.50,45.99], DC:[46.00,52.49], CC:[52.50,57.99], CB:[58.00,62.99], BB:[63.00,67.99], BA:[68.00,70.99], AA:[71.00,100.00]}},
      {name:"Mükemmel 3", xbarLow:65.00, xbarHigh:69.99, ranges:{FD:[0.00,37.99], DD:[38.00,48.99], DC:[49.00,54.99], CC:[55.00,60.49], CB:[60.50,65.49], BB:[65.50,70.49], BA:[70.50,72.99], AA:[73.00,100.00]}},
      {name:"Mükemmel 4", xbarLow:60.00, xbarHigh:64.99, ranges:{FD:[0.00,39.99], DD:[40.00,50.99], DC:[51.00,56.99], CC:[57.00,61.99], CB:[62.00,67.49], BB:[67.50,72.49], BA:[72.50,77.99], AA:[78.00,100.00]}},
      {name:"Çok İyi",     xbarLow:55.00, xbarHigh:59.99, ranges:{FD:[0.00,50.99], DD:[51.00,55.99], DC:[56.00,60.49], CC:[60.50,65.49], CB:[65.50,70.49], BB:[70.50,75.99], BA:[76.00,80.49], AA:[80.50,100.00]}},
      {name:"İyi",         xbarLow:50.00, xbarHigh:54.99, ranges:{FD:[0.00,52.49], DD:[52.50,57.99], DC:[58.00,62.49], CC:[62.50,67.99], CB:[68.00,72.99], BB:[73.00,77.99], BA:[78.00,82.49], AA:[82.50,100.00]}},
      {name:"Orta Üstü",   xbarLow:45.00, xbarHigh:49.99, ranges:{FD:[0.00,54.99], DD:[55.00,58.99], DC:[59.00,64.99], CC:[65.00,69.99], CB:[70.00,74.99], BB:[75.00,79.99], BA:[80.00,84.49], AA:[84.50,100.00]}},
      {name:"Orta",        xbarLow:35.00, xbarHigh:44.99, ranges:{FD:[0.00,56.99], DD:[57.00,61.99], DC:[62.00,66.99], CC:[67.00,71.99], CB:[72.00,76.99], BB:[77.00,81.49], BA:[81.50,87.49], AA:[87.50,100.00]}},
      {name:"Zayıf",       xbarLow:25.00, xbarHigh:34.99, ranges:{FD:[0.00,58.99], DD:[59.00,63.99], DC:[64.00,68.99], CC:[69.00,73.99], CB:[74.00,78.99], BB:[79.00,83.99], BA:[84.00,88.49], AA:[88.50,100.00]}},
      {name:"Kötü",        xbarLow:15.00, xbarHigh:24.99, ranges:{FD:[0.00,60.49], DD:[60.50,66.49], DC:[66.50,70.99], CC:[71.00,75.99], CB:[76.00,80.49], BB:[80.50,85.99], BA:[86.00,90.49], AA:[90.50,100.00]}},
    ]
  }
};

let activeKey = null;

function pickRow(table, xbar){
  for(const row of table){
    if(xbar >= row.xbarLow && xbar <= row.xbarHigh) return row;
  }
  return null;
}

function letterFromT(ranges, t){
  for(const [L, [lo, hi]] of Object.entries(ranges)){
    if(t >= lo && t <= hi) return L;
  }
  if(t < 0) return "FD";
  if(t > 100) return "AA";
  return "FD";
}

function mapToSet(L, letterSet){
  if(letterSet === "9") return L;
  if(L === "FF") return "FF";
  if(L === "FD") return "FD";
  if(L === "DD" || L === "DC") return "DC";
  if(L === "CC" || L === "CB") return "CC";
  if(L === "BB" || L === "BA") return "BB";
  return "AA";
}

function palette(letterSet){
  const pal9 = {"FF":"#7f1d1d","FD":"#b91c1c","DD":"#dc2626","DC":"#f97316","CC":"#f59e0b","CB":"#84cc16","BB":"#22c55e","BA":"#06b6d4","AA":"#2563eb"};
  const pal6 = {"FF":"#7f1d1d","FD":"#b91c1c","DC":"#f97316","CC":"#f59e0b","BB":"#22c55e","AA":"#2563eb"};
  return (letterSet === "6") ? pal6 : pal9;
}

function legendRender(pal, letterSet){
  const legend = document.getElementById("legend");
  legend.innerHTML = "";
  const letters = (letterSet === "6")
    ? ["FF","FD","DC","CC","BB","AA"]
    : ["FF","FD","DD","DC","CC","CB","BB","BA","AA"];
  letters.forEach(L=>{
    const pill = document.createElement("span");
    pill.className="pill";
    const sw = document.createElement("span");
    sw.className="sw";
    sw.style.background = pal[L] || "#9ca3af";
    pill.appendChild(sw);
    pill.appendChild(document.createTextNode(L));
    legend.appendChild(pill);
  });
}

function computeWeighted(myMid, myFinal, clsMid, clsFinal, wMidPct, wFinalPct, extras){
  const wMid = wMidPct/100;
  const wFinal = wFinalPct/100;
  const exN = extras.map(x=>({...x, w: x.wPct/100}));

  const userConst = myMid*wMid + exN.reduce((a,x)=>a + x.my*x.w,0);
  const classConst = clsMid*wMid + exN.reduce((a,x)=>a + x.cls*x.w,0);

  const X = userConst + myFinal*wFinal;
  const Xbar = classConst + clsFinal*wFinal;

  return { X, Xbar, userConst, classConst, wFinal };
}

function gradeMAKU({programKey, myMid, myFinal, clsMid, clsFinal, N, S, wMidPct, wFinalPct, extras}){
  const cfg = CONFIG[programKey];

  // 1) Final barajı (YSSL) -> FD
  if(myFinal < cfg.yssl){
    return {letter:"FD", reason:`Final < YSSL (${cfg.yssl})`, system:"Baraj", X:null, Xbar:null, T:null, level:null };
  }

  const {X, Xbar} = computeWeighted(myMid,myFinal,clsMid,clsFinal,wMidPct,wFinalPct,extras);

  // 2) Mutlak eşikler
  if(X < THRESH.BDKAL) return {letter:"FF", reason:`X < BDKAL (${THRESH.BDKAL})`, system:"Doğrudan", X, Xbar:null, T:null, level:null };
  if(X >= THRESH.BDKUL) return {letter:"AA", reason:`X ≥ BDKÜL (${THRESH.BDKUL})`, system:"Doğrudan", X, Xbar:null, T:null, level:null };
  if(X < THRESH.HBAL) return {letter:"FD", reason:`BDKAL ≤ X < HBAL (${THRESH.HBAL})`, system:"Doğrudan", X, Xbar:null, T:null, level:null };
  if(X >= THRESH.HBUL) return {letter:"AA", reason:`HBÜL (${THRESH.HBUL}) ≤ X < BDKÜL (${THRESH.BDKUL})`, system:"Doğrudan", X, Xbar:null, T:null, level:null };

  // 3) T hesabı
  let T=null, system=null;
  if(N >= 20){
    if(!(S > 0)) return {letter:"—", reason:`S > 0 olmalı`, system:"Bağıl (N≥20)", X, Xbar, T:null, level:null};
    T = ((X - Xbar) / S) * 10 + 70;
    system = "Bağıl (N ≥ 20)";
  } else {
    T = (X - Xbar) + 70;
    system = "Yarı Bağıl (N < 20)";
  }

  const row = pickRow(cfg.table, Xbar);
  if(!row){
    return {letter:"—", reason:`X̄=${Xbar.toFixed(2)} tablo aralığı dışında`, system, X, Xbar, T, level:null};
  }

  const L = letterFromT(row.ranges, T);
  return {letter:L, reason:`${row.name} satırı`, system, X, Xbar, T, level:row.name};
}

/* ---------------- extras UI ---------------- */
const chkExtra = document.getElementById("chkExtra");
const extraArea = document.getElementById("extraArea");
const inpExtraCount = document.getElementById("inpExtraCount");
const extraList = document.getElementById("extraList");

chkExtra.addEventListener("change", ()=>{
  extraArea.style.display = chkExtra.checked ? "block" : "none";
  renderExtras();
});
inpExtraCount.addEventListener("change", renderExtras);

function renderExtras(){
  extraList.innerHTML = "";
  if(!chkExtra.checked) return;
  const n = Number(inpExtraCount.value);
  for(let i=1;i<=n;i++){
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="extraTitle">Ek Kalem ${i}</div>
      <div class="extraGrid">
        <div>
          <label>Ad</label>
          <input id="exName${i}" placeholder="örn: Quiz">
        </div>
        <div>
          <label>Ağırlık (%)</label>
          <input id="exW${i}" type="number" min="0" max="100" placeholder="örn: 10">
        </div>
        <div>
          <label>Senin Notun</label>
          <input id="exMy${i}" type="number" min="0" max="100" placeholder="0-100">
        </div>
        <div>
          <label>Sınıf Ortalaması</label>
          <input id="exCls${i}" type="number" min="0" max="100" placeholder="0-100">
        </div>
      </div>
    `;
    extraList.appendChild(div);
  }
}
renderExtras();

/* ---------------- program selection ---------------- */
const selProgram = document.getElementById("selProgram");
const formArea = document.getElementById("formArea");
const noteProgram = document.getElementById("noteProgram");
const noteBaraj = document.getElementById("noteBaraj");

selProgram.addEventListener("change", ()=>{
  activeKey = selProgram.value;
  formArea.style.display = "block";
  const cfg = CONFIG[activeKey];
  noteProgram.innerHTML = `Seçili: <b>${cfg.label}</b>`;
  noteBaraj.innerHTML = `Final barajı (YSSL): <b>${cfg.yssl}</b> (altı → <b>FD</b>)`;
});

/* ---------------- data collection & validation ---------------- */
function collect(){
  const myMid = Number(document.getElementById("inpMyMid").value);
  const myFinal = Number(document.getElementById("inpMyFinal").value);
  const clsMid = Number(document.getElementById("inpClsMid").value);
  const clsFinal = Number(document.getElementById("inpClsFinal").value);

  const N = Number(document.getElementById("inpN").value);

  const wMidPct = Number(document.getElementById("inpWMid").value);
  const wFinalPct = Number(document.getElementById("inpWFinal").value);

  const finalMin = Number(document.getElementById("inpFinalMin").value);
  const finalMax = Number(document.getElementById("inpFinalMax").value);
  const sMin = Number(document.getElementById("inpSMin").value);
  const sMax = Number(document.getElementById("inpSMax").value);

  const res = Number(document.getElementById("inpRes").value);
  const letterSet = document.getElementById("inpLetterSet").value;

  let extras = [];
  if(chkExtra.checked){
    const n = Number(inpExtraCount.value);
    for(let i=1;i<=n;i++){
      const name = (document.getElementById(`exName${i}`).value || `Ek ${i}`).trim();
      const wPct = Number(document.getElementById(`exW${i}`).value);
      const my = Number(document.getElementById(`exMy${i}`).value);
      const cls = Number(document.getElementById(`exCls${i}`).value);
      extras.push({name, wPct, my, cls});
    }
  }

  return { programKey: activeKey, myMid,myFinal,clsMid,clsFinal,N,wMidPct,wFinalPct,extras, finalMin,finalMax,sMin,sMax,res,letterSet };
}

function validate(d){
  if(!d.programKey) return "Önce program (Lisans/Önlisans) seç.";
  const in01 = x => Number.isFinite(x) && x>=0 && x<=100;

  if(!in01(d.myMid) || !in01(d.myFinal) || !in01(d.clsMid) || !in01(d.clsFinal))
    return "Vize/Final ve sınıf ortalamaları 0–100 olmalı.";

  if(!Number.isFinite(d.N) || d.N < 1) return "N (katılan öğrenci sayısı) en az 1 olmalı.";

  if(!Number.isFinite(d.wMidPct) || !Number.isFinite(d.wFinalPct) || d.wMidPct<0 || d.wFinalPct<0)
    return "Ağırlıklar geçerli değil.";

  for(const ex of d.extras){
    if(!Number.isFinite(ex.wPct) || ex.wPct<0 || ex.wPct>100) return `${ex.name}: ağırlık 0–100 olmalı.`;
    if(!in01(ex.my)) return `${ex.name}: senin notun 0–100 olmalı.`;
    if(!in01(ex.cls)) return `${ex.name}: sınıf ort 0–100 olmalı.`;
  }

  const sum = d.wMidPct + d.wFinalPct + d.extras.reduce((a,x)=>a + x.wPct,0);
  if(Math.round(sum*100)/100 !== 100) return `Ağırlıkların toplamı 100 olmalı. Şu an: ${sum}`;

  if(!Number.isFinite(d.finalMin) || !Number.isFinite(d.finalMax) || d.finalMin<0 || d.finalMax>100 || d.finalMin>=d.finalMax)
    return "Final aralığı hatalı (min<max, 0–100).";
  if(!Number.isFinite(d.sMin) || !Number.isFinite(d.sMax) || d.sMin<=0 || d.sMax>60 || d.sMin>=d.sMax)
    return "S aralığı hatalı (min<max, 0–60).";

  return null;
}

/* ---------------- heatmap drawing ---------------- */
const tip = document.getElementById("tip");
const canvas = document.getElementById("cv");
const statusEl = document.getElementById("status");
const summaryEl = document.getElementById("summary");
let heat = null;

function setupCanvas(){
  const ctx = canvas.getContext("2d");
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.floor(rect.width * dpr);
  canvas.height = Math.floor(rect.height * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return {ctx, W: rect.width, H: rect.height};
}

function drawAll(){
  const d = collect();
  const err = validate(d);
  if(err){
    statusEl.textContent = "⚠️ " + err;
    return;
  }
  statusEl.textContent = "";

  // current summary (mevcut S'yi, heatmapte orta değerden alalım)
  const Scur = (d.sMin + d.sMax) / 2;
  const cur = gradeMAKU({...d, S: Scur});
  const cfg = CONFIG[d.programKey];

  let Xtxt="—", Xbartxt="—";
  try{
    const w = computeWeighted(d.myMid,d.myFinal,d.clsMid,d.clsFinal,d.wMidPct,d.wFinalPct,d.extras);
    Xtxt = w.X.toFixed(2);
    Xbartxt = w.Xbar.toFixed(2);
  }catch(e){}

  const Ttxt = (cur.T==null) ? "—" : cur.T.toFixed(2);

  summaryEl.innerHTML = `
    <b>Program:</b> ${cfg.label} • <b>YSSL:</b> ${cfg.yssl}<br>
    <b>Sistem:</b> ${cur.system}<br>
    <b>Harf (mevcut final):</b> <b>${cur.letter}</b> <span style="opacity:.85">(${cur.reason})</span><br>
    <b>X:</b> ${Xtxt} • <b>X̄:</b> ${Xbartxt} • <b>N:</b> ${d.N} • <b>S(orta):</b> ${Scur.toFixed(2)} • <b>T:</b> ${Ttxt}
  `;

  // draw heatmap
  const {ctx, W, H} = setupCanvas();
  const padL = 54, padR = 14, padT = 18, padB = 44;
  const plot = { x0: padL, y0: padT, x1: W-padR, y1: H-padB };

  const pal = palette(d.letterSet);
  legendRender(pal, d.letterSet);

  const n = d.res;
  const cols = n, rows = n;

  const fmin = d.finalMin;
  const fmax = d.finalMax;
  const smin = d.sMin;
  const smax = d.sMax;

  const cw = (plot.x1 - plot.x0) / cols;
  const ch = (plot.y1 - plot.y0) / rows;

  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = "#0f172a";
  ctx.fillRect(0,0,W,H);

  const data = new Array(rows);

  for(let r=0;r<rows;r++){
    data[r] = new Array(cols);
    const S = smax - (r + 0.5) * (smax - smin) / rows;

    for(let c=0;c<cols;c++){
      const final = fmin + (c + 0.5) * (fmax - fmin) / cols;

      const res = gradeMAKU({...d, myFinal: final, S});
      const Lmapped = mapToSet(res.letter, d.letterSet);
      const color = pal[Lmapped] || "#9ca3af";

      const x = plot.x0 + c*cw;
      const y = plot.y0 + r*ch;

      ctx.fillStyle = color;
      ctx.fillRect(x, y, cw+0.2, ch+0.2);

      let X=null, Xbar=null;
      try{
        const ww = computeWeighted(d.myMid,final,d.clsMid,d.clsFinal,d.wMidPct,d.wFinalPct,d.extras);
        X = ww.X; Xbar = ww.Xbar;
      }catch(e){}

      data[r][c] = {
        final, S,
        letter: res.letter,
        letterMapped: Lmapped,
        system: res.system,
        reason: res.reason,
        level: res.level,
        T: res.T,
        X, Xbar
      };
    }
  }

  // axes & grid
  ctx.strokeStyle = "#1f2937";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(plot.x0, plot.y0);
  ctx.lineTo(plot.x0, plot.y1);
  ctx.lineTo(plot.x1, plot.y1);
  ctx.stroke();

  ctx.fillStyle="#9ca3af";
  ctx.font="12px Arial";
  const xlab="Final";
  ctx.fillText(xlab, (plot.x0+plot.x1)/2 - ctx.measureText(xlab).width/2, plot.y1+32);
  ctx.save();
  ctx.translate(plot.x0-34, (plot.y0+plot.y1)/2);
  ctx.rotate(-Math.PI/2);
  const ylab="S";
  ctx.fillText(ylab, -ctx.measureText(ylab).width/2, 0);
  ctx.restore();

  // ticks
  ctx.fillStyle="#cdd7ea";
  const xt = 5;
  for(let i=0;i<=xt;i++){
    const f = fmin + i*(fmax-fmin)/xt;
    const x = plot.x0 + i*(plot.x1-plot.x0)/xt;
    ctx.strokeStyle="#1f2937";
    ctx.beginPath(); ctx.moveTo(x,plot.y0); ctx.lineTo(x,plot.y1); ctx.stroke();
    ctx.fillText(f.toFixed(0), x-6, plot.y1+18);
  }
  const yt = 5;
  for(let i=0;i<=yt;i++){
    const s = smax - i*(smax-smin)/yt;
    const y = plot.y0 + i*(plot.y1-plot.y0)/yt;
    ctx.strokeStyle="#1f2937";
    ctx.beginPath(); ctx.moveTo(plot.x0,y); ctx.lineTo(plot.x1,y); ctx.stroke();
    ctx.fillText(s.toFixed(1), plot.x0-34, y+4);
  }

  heat = { plot, cols, rows, cw, ch, data };
  statusEl.textContent = `✅ Heatmap hazır. (Final ${fmin}-${fmax}, S ${smin}-${smax}, ${cols}x${rows})`;
}

/* ---------------- tooltip ---------------- */
canvas.addEventListener("mousemove", (e)=>{
  if(!heat) return;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  const {plot, cw, ch, data} = heat;
  if(x < plot.x0 || x > plot.x1 || y < plot.y0 || y > plot.y1){
    tip.style.display="none";
    return;
  }
  const c = Math.floor((x - plot.x0)/cw);
  const r = Math.floor((y - plot.y0)/ch);
  const cell = data?.[r]?.[c];
  if(!cell){ tip.style.display="none"; return; }

  const Ttxt = (cell.T==null) ? "—" : cell.T.toFixed(2);
  const Xtxt = (cell.X==null) ? "—" : cell.X.toFixed(2);
  const Xbartxt = (cell.Xbar==null) ? "—" : cell.Xbar.toFixed(2);
  const level = cell.level ? cell.level : "—";

  tip.innerHTML = [
    `<div class="tipTitle">${cell.letterMapped} <span style="opacity:.8">(${cell.system})</span></div>`,
    `<b>Final:</b> ${cell.final.toFixed(1)} • <b>S:</b> ${cell.S.toFixed(2)}`,
    `<b>X:</b> ${Xtxt} • <b>X̄:</b> ${Xbartxt}`,
    `<b>T:</b> ${Ttxt} • <b>Seviye:</b> ${level}`,
    `<span style="opacity:.85">Kural: ${cell.reason}</span>`,
    (cell.system.includes("Yarı Bağıl") ? `<span style="opacity:.75">Not: N&lt;20 iken S kullanılmaz.</span>` : ``)
  ].join("<br>");
  tip.style.display="block";

  const pad = 14;
  let tx = e.clientX + 14;
  let ty = e.clientY + 14;
  const w = 350;
  const h = 170;
  if(tx + w > window.innerWidth - pad) tx = e.clientX - w - 14;
  if(ty + h > window.innerHeight - pad) ty = e.clientY - h - 14;

  tip.style.left = tx + "px";
  tip.style.top = ty + "px";
});

canvas.addEventListener("mouseleave", ()=> tip.style.display="none");

window.addEventListener("resize", ()=>{
  if(heat){
    try{ drawAll(); }catch(e){}
  }
});
</script>
</body>
</html>
